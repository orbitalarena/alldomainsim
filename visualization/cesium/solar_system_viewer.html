<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Solar System Viewer - All-Domain Simulation</title>
    <script src="lib/Cesium/Cesium.js"></script>
    <link href="lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%;
            background: #000;
            color: #c8cdd5;
            font-family: 'Consolas', 'Courier New', monospace;
            overflow: hidden;
        }
        #cesiumContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .cesium-viewer-bottom { display: none !important; }
        .cesium-viewer-toolbar { display: none !important; }

        /* ─── Info Panel ─── */
        #infoPanel {
            position: absolute; top: 16px; left: 16px; width: 320px;
            background: rgba(10,14,23,0.92); border: 1px solid #1e2a42;
            border-radius: 8px; padding: 18px 20px; font-size: 12px;
            z-index: 100; backdrop-filter: blur(8px);
        }
        #infoPanel h2 { font-size: 16px; color: #e8ecf2; margin-bottom: 4px; font-weight: 600; }
        #infoPanel .subtitle { font-size: 11px; color: #5a6a80; margin-bottom: 14px; }
        .info-section { margin-bottom: 12px; }
        .info-section h3 {
            font-size: 11px; color: #4a9eff; text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 6px;
        }
        .info-row { display: flex; justify-content: space-between; padding: 2px 0; color: #8a96a6; }
        .info-row .label { color: #6b7a90; }
        .info-row .value { color: #c8cdd5; text-align: right; }
        .info-row .value.green { color: #2ecc71; }
        .info-row .value.red { color: #e74c3c; }
        .info-row .value.cyan { color: #4a9eff; }
        .info-row .value.gold { color: #FFD700; }

        /* ─── Time Controls ─── */
        #timeControls {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            background: rgba(10,14,23,0.92); border: 1px solid #1e2a42;
            border-radius: 8px; padding: 12px 20px;
            display: flex; align-items: center; gap: 16px;
            z-index: 100; backdrop-filter: blur(8px);
        }
        #timeControls button {
            background: #1a2235; border: 1px solid #2a3f5f; color: #c8cdd5;
            padding: 6px 14px; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-size: 12px; transition: all 0.15s;
        }
        #timeControls button:hover { background: #243352; border-color: #4a9eff; }
        #timeControls button.active { background: #1e3a5f; border-color: #4a9eff; color: #4a9eff; }
        #epochDisplay { font-size: 14px; color: #e8ecf2; min-width: 140px; text-align: center; }
        #warpDisplay { font-size: 11px; color: #f39c12; min-width: 60px; text-align: center; }

        /* ─── Scale/View Toggles ─── */
        #topRightControls {
            position: absolute; top: 16px; right: 16px; z-index: 100;
            display: flex; flex-direction: column; gap: 6px;
        }
        #topRightControls button {
            background: rgba(10,14,23,0.92); border: 1px solid #1e2a42; color: #c8cdd5;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-family: inherit; font-size: 12px; backdrop-filter: blur(8px);
            transition: all 0.15s; text-align: left;
        }
        #topRightControls button:hover { border-color: #4a9eff; color: #4a9eff; }
        #topRightControls button.active { border-color: #4a9eff; color: #4a9eff; background: #1e3a5f; }

        /* ─── Planet Legend ─── */
        #planetLegend {
            position: absolute; bottom: 80px; right: 16px;
            background: rgba(10,14,23,0.85); border: 1px solid #1e2a42;
            border-radius: 6px; padding: 10px 14px; font-size: 11px; z-index: 100;
        }
        .legend-item {
            display: flex; align-items: center; gap: 8px; padding: 3px 0;
            color: #8a96a6; cursor: pointer; transition: all 0.1s;
        }
        .legend-item:hover { color: #e8ecf2; }
        .legend-item.selected { color: #FFD700; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* ─── Transfer Planner Panel ─── */
        #transferPanel {
            position: absolute; bottom: 80px; left: 16px; width: 320px;
            background: rgba(10,14,23,0.92); border: 1px solid #1e2a42;
            border-radius: 8px; padding: 14px 16px; font-size: 12px;
            z-index: 100; backdrop-filter: blur(8px); display: none;
        }
        #transferPanel.visible { display: block; }
        #transferPanel h3 { font-size: 11px; color: #FFD700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .transfer-hint { color: #5a6a80; font-size: 11px; margin-bottom: 8px; }
        #transferPanel .info-row .value.gold { color: #FFD700; }

        /* ─── Loading Overlay ─── */
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 200;
            color: #4a9eff; font-size: 16px;
        }
        #loadingOverlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #1e2a42;
            border-top-color: #4a9eff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ─── Keyboard Help ─── */
        #helpOverlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: rgba(10,14,23,0.95); border: 1px solid #2a3f5f;
            border-radius: 10px; padding: 24px 30px; z-index: 300;
            display: none; min-width: 320px;
        }
        #helpOverlay.visible { display: block; }
        #helpOverlay h3 { color: #e8ecf2; margin-bottom: 12px; font-size: 14px; }
        .help-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
        .help-row .key { color: #4a9eff; font-weight: 600; min-width: 80px; }
        .help-row .desc { color: #8a96a6; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <span>Initializing Solar System...</span>
    </div>

    <!-- Info Panel -->
    <div id="infoPanel">
        <h2>Solar System Viewer</h2>
        <div class="subtitle">Heliocentric J2000 Equatorial</div>
        <div class="info-section">
            <h3>Epoch</h3>
            <div class="info-row"><span class="label">Date</span><span class="value" id="infoDate">--</span></div>
            <div class="info-row"><span class="label">Julian Date</span><span class="value" id="infoJD">--</span></div>
        </div>
        <div class="info-section" id="planetInfo" style="display:none">
            <h3 id="planetInfoName">--</h3>
            <div class="info-row"><span class="label">Distance from Sun</span><span class="value" id="piDist">--</span></div>
            <div class="info-row"><span class="label">Orbital Speed</span><span class="value" id="piSpeed">--</span></div>
            <div class="info-row"><span class="label">Orbital Period</span><span class="value" id="piPeriod">--</span></div>
            <div class="info-row"><span class="label">Radius</span><span class="value" id="piRadius">--</span></div>
            <div class="info-row"><span class="label">Gravity (mu)</span><span class="value" id="piMu">--</span></div>
        </div>
    </div>

    <!-- Transfer Planner -->
    <div id="transferPanel">
        <h3>Transfer Planner</h3>
        <div class="transfer-hint" id="tfHint">Click a planet to select departure, then another for arrival</div>
        <div id="tfResults" style="display:none">
            <div class="info-row"><span class="label">Route</span><span class="value cyan" id="tfRoute">--</span></div>
            <div class="info-row"><span class="label">Departure</span><span class="value green" id="tfDepart">--</span></div>
            <div class="info-row"><span class="label">Arrival</span><span class="value red" id="tfArrive">--</span></div>
            <div class="info-row"><span class="label">TOF</span><span class="value" id="tfTOF">--</span></div>
            <div class="info-row"><span class="label">Hohmann DV</span><span class="value gold" id="tfDV">--</span></div>
            <div class="info-row"><span class="label">C3 Departure</span><span class="value gold" id="tfC3">--</span></div>
            <div class="info-row"><span class="label">Transfer SMA</span><span class="value" id="tfSMA">--</span></div>
        </div>
    </div>

    <!-- Time Controls -->
    <div id="timeControls">
        <button id="btnSlower" title="Slow down">&#9664;&#9664;</button>
        <button id="btnPlayPause" title="Play/Pause">&#9654;</button>
        <button id="btnFaster" title="Speed up">&#9654;&#9654;</button>
        <span id="epochDisplay">--</span>
        <span id="warpDisplay">1x</span>
        <button id="btnReset" title="Reset to J2000">J2000</button>
        <button id="btnToday" title="Go to today">Today</button>
    </div>

    <!-- Top Right Controls -->
    <div id="topRightControls">
        <button id="btnScale" title="Toggle planet scale">Scale: Exaggerated</button>
        <button id="btnBelt" title="Toggle asteroid belt">Asteroid Belt: On</button>
        <button id="btnTransfer" title="Toggle transfer planner">Transfer Planner</button>
        <button id="btnInner" title="Toggle inner/full view">View: Full System</button>
    </div>

    <!-- Planet Legend -->
    <div id="planetLegend"></div>

    <!-- Help Overlay -->
    <div id="helpOverlay">
        <h3>Keyboard Controls</h3>
        <div class="help-row"><span class="key">Space</span><span class="desc">Play / Pause</span></div>
        <div class="help-row"><span class="key">+ / -</span><span class="desc">Time warp faster / slower</span></div>
        <div class="help-row"><span class="key">R</span><span class="desc">Reset to J2000</span></div>
        <div class="help-row"><span class="key">T</span><span class="desc">Jump to today</span></div>
        <div class="help-row"><span class="key">S</span><span class="desc">Toggle planet scale</span></div>
        <div class="help-row"><span class="key">B</span><span class="desc">Toggle asteroid belt</span></div>
        <div class="help-row"><span class="key">P</span><span class="desc">Toggle transfer planner</span></div>
        <div class="help-row"><span class="key">I</span><span class="desc">Inner / Full system view</span></div>
        <div class="help-row"><span class="key">H</span><span class="desc">Toggle this help</span></div>
        <div class="help-row"><span class="key">1-8</span><span class="desc">Fly to planet</span></div>
        <div class="help-row"><span class="key">Esc</span><span class="desc">Clear selection</span></div>
    </div>

    <!-- Dependencies -->
    <script src="cesium_config.js"></script>
    <script src="js/framework/solar_system_engine.js"></script>
    <script>
    (function() {
        'use strict';

        var SSE = SolarSystemEngine;
        var AU = SSE.AU;

        // Scale factor: divide all positions by this to keep within float32 precision.
        // Neptune at 30 AU = 4.5e12 m → 4.5e6 scaled units (safe for WebGL).
        var SCALE = 1e6;
        var AU_S = AU / SCALE;  // scaled AU for camera distances

        // State
        var currentJD = SSE.dateToJD(new Date());
        var playing = false;
        var timeWarp = 1;
        var warpLevels = [0.1, 0.5, 1, 5, 10, 30, 100, 365, 1000, 3650];
        var warpIndex = 2;
        var realScale = false;
        var showBelt = true;
        var innerView = false;

        // Transfer planner state
        var transferMode = false;
        var transferDeparture = null;  // planet key
        var transferArrival = null;    // planet key
        var transferPolyline = null;
        var departureMarker = null;
        var arrivalMarker = null;

        // Cesium entities
        var planetEntities = {};
        var orbitPolylines = {};
        var sunEntity = null;
        var beltEntities = [];
        var distanceLine = null;
        var viewer;

        // ═════════════════════════════════════════════════════════════════
        // Initialize Cesium — wrapped in try-catch for robustness
        // ═════════════════════════════════════════════════════════════════
        try {
            viewer = new Cesium.Viewer('cesiumContainer', {
                skyBox: false,
                skyAtmosphere: false,
                globe: false,
                baseLayerPicker: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                selectionIndicator: false,
                timeline: false,
                animation: false,
                navigationHelpButton: false,
                sceneModePicker: false,
                fullscreenButton: false,
                vrButton: false,
                contextOptions: { webgl: { alpha: true } }
            });

            viewer.scene.backgroundColor = Cesium.Color.fromCssColorString('#000005');
            if (viewer.scene.sun) viewer.scene.sun.show = false;
            if (viewer.scene.moon) viewer.scene.moon.show = false;

            // Camera: looking down on ecliptic from ~3.5 AU (scaled)
            var camDist = 3.5 * AU_S;
            viewer.camera.position = new Cesium.Cartesian3(0, 0, camDist);
            viewer.camera.direction = new Cesium.Cartesian3(0, 0, -1);
            viewer.camera.up = new Cesium.Cartesian3(0, 1, 0);

        } catch (e) {
            console.error('Failed to create Cesium viewer:', e);
            document.getElementById('loadingOverlay').innerHTML =
                '<span style="color:#e74c3c">Failed to initialize 3D viewer. Check console.</span>';
            return;
        }

        // ═════════════════════════════════════════════════════════════════
        // Position scaling helper — SSE returns meters, we need scaled units
        // ═════════════════════════════════════════════════════════════════
        function scaledPos(pos) {
            return new Cesium.Cartesian3(pos.x / SCALE, pos.y / SCALE, pos.z / SCALE);
        }

        // ═════════════════════════════════════════════════════════════════
        // Create Sun
        // ═════════════════════════════════════════════════════════════════
        sunEntity = viewer.entities.add({
            position: Cesium.Cartesian3.ZERO,
            point: {
                pixelSize: 24,
                color: Cesium.Color.fromCssColorString('#FFD700'),
                outlineColor: Cesium.Color.fromCssColorString('#FFA500'),
                outlineWidth: 4,
                disableDepthTestDistance: Number.POSITIVE_INFINITY
            },
            label: {
                text: 'Sun',
                font: '13px monospace',
                fillColor: Cesium.Color.fromCssColorString('#FFD700'),
                style: Cesium.LabelStyle.FILL,
                pixelOffset: new Cesium.Cartesian2(0, -26),
                disableDepthTestDistance: Number.POSITIVE_INFINITY
            }
        });

        // ═════════════════════════════════════════════════════════════════
        // Create Planets and Orbit Lines
        // ═════════════════════════════════════════════════════════════════
        var legendHTML = '';

        for (var pi = 0; pi < SSE.PLANET_KEYS.length; pi++) {
            var key = SSE.PLANET_KEYS[pi];
            var planet = SSE.PLANETS[key];

            try {
                var pos = SSE.getPlanetPositionHCI(key, currentJD);
                var orbitAlpha = pi < 4 ? 0.5 : 0.25;
                var orbitWidth = pi < 4 ? 2 : 1;

                // Generate orbit path
                var orbitPath = SSE.getOrbitPath(key, currentJD, 360);
                var orbitPositions = [];
                for (var oi = 0; oi < orbitPath.length; oi++) {
                    orbitPositions.push(scaledPos(orbitPath[oi]));
                }

                // Orbit polyline
                orbitPolylines[key] = viewer.entities.add({
                    polyline: {
                        positions: orbitPositions,
                        width: orbitWidth,
                        material: Cesium.Color.fromCssColorString(planet.color).withAlpha(orbitAlpha),
                        clampToGround: false
                    }
                });

                // Planet point + label
                var pointSize = pi < 4 ? 10 : (pi < 6 ? 14 : 8);
                planetEntities[key] = viewer.entities.add({
                    position: scaledPos(pos),
                    point: {
                        pixelSize: pointSize,
                        color: Cesium.Color.fromCssColorString(planet.color),
                        outlineColor: Cesium.Color.fromCssColorString(planet.color).withAlpha(0.4),
                        outlineWidth: 2,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    },
                    label: {
                        text: planet.name,
                        font: '11px monospace',
                        fillColor: Cesium.Color.fromCssColorString(planet.color).withAlpha(0.9),
                        style: Cesium.LabelStyle.FILL,
                        pixelOffset: new Cesium.Cartesian2(0, -18),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
            } catch (e) {
                console.warn('Failed to create planet ' + key + ':', e);
            }

            legendHTML += '<div class="legend-item" data-planet="' + key + '">' +
                '<div class="legend-dot" style="background:' + planet.color + '"></div>' +
                planet.name + '</div>';
        }

        document.getElementById('planetLegend').innerHTML = legendHTML;

        // ═════════════════════════════════════════════════════════════════
        // Asteroid Belt Visualization
        // ═════════════════════════════════════════════════════════════════
        function createAsteroidBelt() {
            // Belt between Mars and Jupiter: ~2.1 to 3.3 AU
            var beltInner = 2.1 * AU_S;
            var beltOuter = 3.3 * AU_S;
            var numRings = 3;

            for (var ring = 0; ring < numRings; ring++) {
                var r = beltInner + (beltOuter - beltInner) * (ring + 0.5) / numRings;
                var pts = [];
                var nPts = 200;
                for (var i = 0; i <= nPts; i++) {
                    var angle = (i / nPts) * 2 * Math.PI;
                    // Slight random variation for organic look (use sin of primes)
                    var rVar = r * (1 + 0.04 * Math.sin(angle * 7.3 + ring * 2.1) +
                                         0.02 * Math.sin(angle * 13.7 + ring * 5.3));
                    pts.push(new Cesium.Cartesian3(
                        rVar * Math.cos(angle),
                        rVar * Math.sin(angle) * Math.cos(SSE.OBLIQUITY_J2000),
                        rVar * Math.sin(angle) * Math.sin(SSE.OBLIQUITY_J2000)
                    ));
                }
                var alpha = 0.08 + ring * 0.03;
                var ent = viewer.entities.add({
                    polyline: {
                        positions: pts,
                        width: 1,
                        material: Cesium.Color.fromCssColorString('#8B7355').withAlpha(alpha),
                        clampToGround: false
                    }
                });
                beltEntities.push(ent);
            }

            // Scatter some individual "rocks" as points
            var numRocks = 150;
            for (var ri = 0; ri < numRocks; ri++) {
                var angle = Math.random() * 2 * Math.PI;
                var r = beltInner + Math.random() * (beltOuter - beltInner);
                // Random inclination up to ~15 degrees
                var inc = (Math.random() - 0.5) * 15 * Math.PI / 180;
                var x = r * Math.cos(angle);
                var y_ecl = r * Math.sin(angle);
                var z_ecl = r * Math.sin(inc) * 0.3;
                // Ecliptic to equatorial
                var y_eq = y_ecl * Math.cos(SSE.OBLIQUITY_J2000) - z_ecl * Math.sin(SSE.OBLIQUITY_J2000);
                var z_eq = y_ecl * Math.sin(SSE.OBLIQUITY_J2000) + z_ecl * Math.cos(SSE.OBLIQUITY_J2000);

                var ent = viewer.entities.add({
                    position: new Cesium.Cartesian3(x, y_eq, z_eq),
                    point: {
                        pixelSize: 1 + Math.random() * 2,
                        color: Cesium.Color.fromCssColorString('#8B7355').withAlpha(0.3 + Math.random() * 0.3),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
                beltEntities.push(ent);
            }
        }

        createAsteroidBelt();

        // ═════════════════════════════════════════════════════════════════
        // Hohmann Transfer Calculator
        // ═════════════════════════════════════════════════════════════════
        function computeHohmannTransfer(depKey, arrKey) {
            var depPlanet = SSE.PLANETS[depKey];
            var arrPlanet = SSE.PLANETS[arrKey];
            var r1 = depPlanet.sma_au * AU;  // meters
            var r2 = arrPlanet.sma_au * AU;

            // Hohmann transfer semi-major axis
            var a_transfer = (r1 + r2) / 2;

            // Transfer orbit velocities (vis-viva)
            var v_dep_orbit = Math.sqrt(SSE.MU_SUN / r1);  // circular orbit speed at departure
            var v_arr_orbit = Math.sqrt(SSE.MU_SUN / r2);  // circular orbit speed at arrival

            var v_dep_transfer = Math.sqrt(SSE.MU_SUN * (2/r1 - 1/a_transfer));
            var v_arr_transfer = Math.sqrt(SSE.MU_SUN * (2/r2 - 1/a_transfer));

            var dv1 = Math.abs(v_dep_transfer - v_dep_orbit);
            var dv2 = Math.abs(v_arr_orbit - v_arr_transfer);
            var dv_total = dv1 + dv2;

            // C3 at departure
            var v_inf = Math.abs(v_dep_transfer - v_dep_orbit);
            var c3 = (v_inf * v_inf) / 1e6;  // km^2/s^2

            // Time of flight (half the transfer orbit period)
            var tof_seconds = Math.PI * Math.sqrt(a_transfer * a_transfer * a_transfer / SSE.MU_SUN);
            var tof_days = tof_seconds / 86400;

            return {
                a_transfer: a_transfer,
                dv1: dv1,
                dv2: dv2,
                dv_total: dv_total,
                c3: c3,
                tof_days: tof_days,
                r1: r1,
                r2: r2
            };
        }

        function showTransferArc(depKey, arrKey) {
            clearTransferVisuals();

            var result = computeHohmannTransfer(depKey, arrKey);
            var depPos = SSE.getPlanetPositionHCI(depKey, currentJD);
            var arrPos = SSE.getPlanetPositionHCI(arrKey, currentJD);

            // Build transfer ellipse arc: half ellipse from departure to arrival
            var depR = SSE.vecMag(depPos);
            var arrR = SSE.vecMag(arrPos);
            var arcPts = [];
            var nSteps = 200;

            // Use actual planet positions for visual arc
            for (var i = 0; i <= nSteps; i++) {
                var frac = i / nSteps;
                var angle = frac * Math.PI;  // 0 to pi (half orbit)

                // Interpolate radius along transfer ellipse
                var a = result.a_transfer;
                var e = Math.abs(result.r2 - result.r1) / (result.r1 + result.r2);
                if (result.r2 > result.r1) {
                    // Outbound: periapsis at departure
                    var nu = angle;
                    var r = a * (1 - e*e) / (1 + e * Math.cos(nu));
                } else {
                    // Inbound: periapsis at arrival
                    var nu = Math.PI + angle;
                    var r = a * (1 - e*e) / (1 + e * Math.cos(nu));
                }

                // Interpolate direction between departure and arrival (in ecliptic plane)
                var depAngle = Math.atan2(depPos.y, depPos.x);
                var arrAngle = Math.atan2(arrPos.y, arrPos.x);
                // Ensure we go the short way for inner transfers, long way for outer
                var dAngle = arrAngle - depAngle;
                if (result.r2 > result.r1) {
                    // Outbound: should go prograde (positive angle)
                    if (dAngle < 0) dAngle += 2 * Math.PI;
                } else {
                    if (dAngle > 0) dAngle -= 2 * Math.PI;
                    dAngle = Math.abs(dAngle);
                }
                var curAngle = depAngle + frac * (result.r2 > result.r1 ? dAngle : -dAngle);

                arcPts.push(new Cesium.Cartesian3(
                    r / SCALE * Math.cos(curAngle),
                    r / SCALE * Math.sin(curAngle),
                    0
                ));
            }

            transferPolyline = viewer.entities.add({
                polyline: {
                    positions: arcPts,
                    width: 3,
                    material: new Cesium.PolylineGlowMaterialProperty({
                        glowPower: 0.2,
                        color: Cesium.Color.fromCssColorString('#FFD700')
                    }),
                    clampToGround: false
                }
            });

            departureMarker = viewer.entities.add({
                position: scaledPos(depPos),
                point: {
                    pixelSize: 14, color: Cesium.Color.fromCssColorString('#2ecc71'),
                    outlineColor: Cesium.Color.WHITE, outlineWidth: 2,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                },
                label: {
                    text: 'DEPARTURE', font: '10px monospace',
                    fillColor: Cesium.Color.fromCssColorString('#2ecc71'),
                    pixelOffset: new Cesium.Cartesian2(0, 20),
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });

            arrivalMarker = viewer.entities.add({
                position: scaledPos(arrPos),
                point: {
                    pixelSize: 14, color: Cesium.Color.fromCssColorString('#e74c3c'),
                    outlineColor: Cesium.Color.WHITE, outlineWidth: 2,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                },
                label: {
                    text: 'ARRIVAL', font: '10px monospace',
                    fillColor: Cesium.Color.fromCssColorString('#e74c3c'),
                    pixelOffset: new Cesium.Cartesian2(0, 20),
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });

            // Update panel
            var depName = SSE.PLANETS[depKey].name;
            var arrName = SSE.PLANETS[arrKey].name;
            document.getElementById('tfRoute').textContent = depName + ' -> ' + arrName;
            document.getElementById('tfDepart').textContent = depName + ' (' + SSE.jdToDateString(currentJD) + ')';
            document.getElementById('tfArrive').textContent = arrName;
            document.getElementById('tfTOF').textContent = result.tof_days.toFixed(1) + ' days (' + (result.tof_days / 30.44).toFixed(1) + ' months)';
            document.getElementById('tfDV').textContent = (result.dv_total / 1000).toFixed(3) + ' km/s';
            document.getElementById('tfC3').textContent = result.c3.toFixed(2) + ' km\u00B2/s\u00B2';
            document.getElementById('tfSMA').textContent = (result.a_transfer / AU).toFixed(3) + ' AU';
            document.getElementById('tfResults').style.display = 'block';
        }

        function clearTransferVisuals() {
            if (transferPolyline) { viewer.entities.remove(transferPolyline); transferPolyline = null; }
            if (departureMarker) { viewer.entities.remove(departureMarker); departureMarker = null; }
            if (arrivalMarker) { viewer.entities.remove(arrivalMarker); arrivalMarker = null; }
        }

        // ═════════════════════════════════════════════════════════════════
        // Update Loop
        // ═════════════════════════════════════════════════════════════════
        var lastTime = performance.now();

        function updatePlanetPositions() {
            for (var i = 0; i < SSE.PLANET_KEYS.length; i++) {
                var key = SSE.PLANET_KEYS[i];
                try {
                    var pos = SSE.getPlanetPositionHCI(key, currentJD);
                    if (isFinite(pos.x) && isFinite(pos.y) && isFinite(pos.z)) {
                        planetEntities[key].position = scaledPos(pos);
                    }
                } catch (e) { /* skip */ }
            }
        }

        function updateDisplay() {
            document.getElementById('infoDate').textContent = SSE.jdToDateString(currentJD);
            document.getElementById('infoJD').textContent = currentJD.toFixed(2);
            document.getElementById('epochDisplay').textContent = SSE.jdToDateString(currentJD);
            document.getElementById('warpDisplay').textContent =
                (timeWarp >= 365 ? (timeWarp / 365).toFixed(1) + ' yr/s' :
                 timeWarp >= 1 ? timeWarp.toFixed(1) + ' d/s' :
                 (timeWarp * 24).toFixed(1) + ' hr/s');
        }

        function tick() {
            var now = performance.now();
            var dt = Math.min((now - lastTime) / 1000, 0.1);  // Cap dt to prevent jumps
            lastTime = now;

            if (playing) {
                currentJD += timeWarp * dt;
                updatePlanetPositions();
            }

            updateDisplay();
            requestAnimationFrame(tick);
        }

        // ═════════════════════════════════════════════════════════════════
        // Controls
        // ═════════════════════════════════════════════════════════════════
        function togglePlay() {
            playing = !playing;
            document.getElementById('btnPlayPause').innerHTML = playing ? '&#9646;&#9646;' : '&#9654;';
            document.getElementById('btnPlayPause').classList.toggle('active', playing);
        }

        function goFaster() {
            if (warpIndex < warpLevels.length - 1) { warpIndex++; timeWarp = warpLevels[warpIndex]; }
        }

        function goSlower() {
            if (warpIndex > 0) { warpIndex--; timeWarp = warpLevels[warpIndex]; }
        }

        function resetToJ2000() { currentJD = SSE.J2000_EPOCH; updatePlanetPositions(); }

        function goToToday() { currentJD = SSE.dateToJD(new Date()); updatePlanetPositions(); }

        function toggleScale() {
            realScale = !realScale;
            document.getElementById('btnScale').textContent = 'Scale: ' + (realScale ? 'Real' : 'Exaggerated');
            for (var i = 0; i < SSE.PLANET_KEYS.length; i++) {
                var key = SSE.PLANET_KEYS[i];
                var entity = planetEntities[key];
                if (!entity) continue;
                if (realScale) {
                    entity.point.pixelSize = Math.max(2, Math.min(5, SSE.PLANETS[key].radius / 8e6));
                } else {
                    entity.point.pixelSize = i < 4 ? 10 : (i < 6 ? 14 : 8);
                }
            }
        }

        function toggleBelt() {
            showBelt = !showBelt;
            document.getElementById('btnBelt').textContent = 'Asteroid Belt: ' + (showBelt ? 'On' : 'Off');
            for (var i = 0; i < beltEntities.length; i++) {
                beltEntities[i].show = showBelt;
            }
        }

        function toggleTransferMode() {
            transferMode = !transferMode;
            document.getElementById('btnTransfer').classList.toggle('active', transferMode);
            document.getElementById('transferPanel').classList.toggle('visible', transferMode);
            if (!transferMode) {
                transferDeparture = null;
                transferArrival = null;
                clearTransferVisuals();
                document.getElementById('tfResults').style.display = 'none';
                document.getElementById('tfHint').textContent = 'Click a planet to select departure, then another for arrival';
                // Clear legend selection
                var items = document.querySelectorAll('.legend-item');
                for (var i = 0; i < items.length; i++) items[i].classList.remove('selected');
            }
        }

        function toggleInnerView() {
            innerView = !innerView;
            document.getElementById('btnInner').textContent = 'View: ' + (innerView ? 'Inner System' : 'Full System');

            // Show/hide outer planet orbits and labels
            var outerPlanets = ['JUPITER', 'SATURN', 'URANUS', 'NEPTUNE'];
            for (var i = 0; i < outerPlanets.length; i++) {
                var k = outerPlanets[i];
                if (orbitPolylines[k]) orbitPolylines[k].show = !innerView;
                if (planetEntities[k]) planetEntities[k].show = !innerView;
            }

            // Adjust camera
            var dist = innerView ? 1.8 * AU_S : 3.5 * AU_S;
            viewer.camera.flyTo({
                destination: new Cesium.Cartesian3(0, 0, dist),
                orientation: {
                    direction: new Cesium.Cartesian3(0, 0, -1),
                    up: new Cesium.Cartesian3(0, 1, 0)
                },
                duration: 1.5
            });

            // Show/hide belt based on view
            for (var i = 0; i < beltEntities.length; i++) {
                beltEntities[i].show = showBelt && !innerView;
            }
        }

        function flyToPlanet(planetKey) {
            if (!planetEntities[planetKey]) return;
            var pos = SSE.getPlanetPositionHCI(planetKey, currentJD);
            var offset = SSE.PLANETS[planetKey].sma_au * AU_S * 0.3;
            var sp = scaledPos(pos);
            viewer.camera.flyTo({
                destination: new Cesium.Cartesian3(sp.x + offset * 0.3, sp.y + offset * 0.3, sp.z + offset),
                orientation: {
                    direction: Cesium.Cartesian3.normalize(
                        new Cesium.Cartesian3(-0.3, -0.3, -1), new Cesium.Cartesian3()
                    ),
                    up: new Cesium.Cartesian3(0, 1, 0)
                },
                duration: 2.0
            });
            showPlanetInfo(planetKey);
        }

        function showPlanetInfo(planetKey) {
            var planet = SSE.PLANETS[planetKey];
            var pos = SSE.getPlanetPositionHCI(planetKey, currentJD);
            var vel = SSE.getPlanetVelocityHCI(planetKey, currentJD);
            var speed = SSE.vecMag(vel);
            var dist = SSE.vecMag(pos);

            var period_years = Math.pow(planet.sma_au, 1.5);

            var infoEl = document.getElementById('planetInfo');
            infoEl.style.display = 'block';
            document.getElementById('planetInfoName').textContent = planet.name;
            document.getElementById('planetInfoName').style.color = planet.color;
            document.getElementById('piDist').textContent = (dist / AU).toFixed(3) + ' AU (' + (dist / 1e9).toFixed(1) + ' Gm)';
            document.getElementById('piSpeed').textContent = (speed / 1000).toFixed(2) + ' km/s';
            document.getElementById('piPeriod').textContent = period_years.toFixed(2) + ' years (' + (period_years * 365.25).toFixed(0) + ' days)';
            document.getElementById('piRadius').textContent = (planet.radius / 1000).toFixed(0) + ' km';
            document.getElementById('piMu').textContent = planet.mu.toExponential(3) + ' m\u00B3/s\u00B2';
        }

        function selectPlanetForTransfer(planetKey) {
            if (!transferMode) return;

            if (!transferDeparture) {
                transferDeparture = planetKey;
                document.getElementById('tfHint').textContent =
                    'Departure: ' + SSE.PLANETS[planetKey].name + '. Now click arrival planet.';
                // Highlight in legend
                var items = document.querySelectorAll('.legend-item');
                for (var i = 0; i < items.length; i++) {
                    if (items[i].getAttribute('data-planet') === planetKey) {
                        items[i].classList.add('selected');
                    }
                }
            } else if (!transferArrival && planetKey !== transferDeparture) {
                transferArrival = planetKey;
                document.getElementById('tfHint').textContent =
                    SSE.PLANETS[transferDeparture].name + ' -> ' + SSE.PLANETS[planetKey].name;
                showTransferArc(transferDeparture, transferArrival);
            } else {
                // Reset and start over
                transferDeparture = planetKey;
                transferArrival = null;
                clearTransferVisuals();
                document.getElementById('tfResults').style.display = 'none';
                document.getElementById('tfHint').textContent =
                    'Departure: ' + SSE.PLANETS[planetKey].name + '. Now click arrival planet.';
                var items = document.querySelectorAll('.legend-item');
                for (var i = 0; i < items.length; i++) {
                    items[i].classList.remove('selected');
                    if (items[i].getAttribute('data-planet') === planetKey) {
                        items[i].classList.add('selected');
                    }
                }
            }
        }

        // ═════════════════════════════════════════════════════════════════
        // Event Listeners
        // ═════════════════════════════════════════════════════════════════
        document.getElementById('btnPlayPause').addEventListener('click', togglePlay);
        document.getElementById('btnFaster').addEventListener('click', goFaster);
        document.getElementById('btnSlower').addEventListener('click', goSlower);
        document.getElementById('btnReset').addEventListener('click', resetToJ2000);
        document.getElementById('btnToday').addEventListener('click', goToToday);
        document.getElementById('btnScale').addEventListener('click', toggleScale);
        document.getElementById('btnBelt').addEventListener('click', toggleBelt);
        document.getElementById('btnTransfer').addEventListener('click', toggleTransferMode);
        document.getElementById('btnInner').addEventListener('click', toggleInnerView);

        // Legend clicks
        document.getElementById('planetLegend').addEventListener('click', function(e) {
            var item = e.target.closest('.legend-item');
            if (!item) return;
            var key = item.getAttribute('data-planet');
            if (!key) return;

            if (transferMode) {
                selectPlanetForTransfer(key);
            } else {
                flyToPlanet(key);
            }
        });

        // Keyboard
        document.addEventListener('keydown', function(e) {
            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case '+': case '=': goFaster(); break;
                case '-': case '_': goSlower(); break;
                case 'r': case 'R': resetToJ2000(); break;
                case 't': case 'T': goToToday(); break;
                case 's': case 'S': toggleScale(); break;
                case 'b': case 'B': toggleBelt(); break;
                case 'p': case 'P': toggleTransferMode(); break;
                case 'i': case 'I': toggleInnerView(); break;
                case 'h': case 'H':
                    document.getElementById('helpOverlay').classList.toggle('visible');
                    break;
                case 'Escape':
                    document.getElementById('helpOverlay').classList.remove('visible');
                    document.getElementById('planetInfo').style.display = 'none';
                    if (transferMode) {
                        transferDeparture = null;
                        transferArrival = null;
                        clearTransferVisuals();
                        document.getElementById('tfResults').style.display = 'none';
                        document.getElementById('tfHint').textContent = 'Click a planet to select departure, then another for arrival';
                        var items = document.querySelectorAll('.legend-item');
                        for (var i = 0; i < items.length; i++) items[i].classList.remove('selected');
                    }
                    break;
                case '1': flyToPlanet('MERCURY'); break;
                case '2': flyToPlanet('VENUS'); break;
                case '3': flyToPlanet('EARTH'); break;
                case '4': flyToPlanet('MARS'); break;
                case '5': flyToPlanet('JUPITER'); break;
                case '6': flyToPlanet('SATURN'); break;
                case '7': flyToPlanet('URANUS'); break;
                case '8': flyToPlanet('NEPTUNE'); break;
            }
        });

        // ═════════════════════════════════════════════════════════════════
        // Startup
        // ═════════════════════════════════════════════════════════════════
        updatePlanetPositions();
        updateDisplay();

        // Hide loading overlay immediately — everything is computed in JS
        document.getElementById('loadingOverlay').classList.add('hidden');

        // Start render loop
        lastTime = performance.now();
        requestAnimationFrame(tick);

    })();
    </script>
</body>
</html>
