<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>All-Domain Simulation - Orbit Viewer</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-family: sans-serif;
            z-index: 1000;
            min-width: 220px;
        }
        #controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        #controls button {
            padding: 8px 15px;
            margin: 5px 5px 5px 0;
            cursor: pointer;
            background: #2196F3;
            border: none;
            border-radius: 3px;
            color: white;
            font-size: 14px;
        }
        #controls button:hover {
            background: #1976D2;
        }
        #controls label {
            display: block;
            margin: 10px 0 5px 0;
            font-size: 13px;
        }
        #controls input[type="range"] {
            width: 100%;
        }
        #controls input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }
        #status {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
        }
        #speedValue {
            color: #4CAF50;
            font-weight: bold;
        }
        #infoBox {
            position: absolute;
            bottom: 100px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: none;
            max-width: 300px;
        }
        #infoBox h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        #infoBox .close {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h3>All-Domain Simulation</h3>
        <button onclick="loadOrbitData()">Load Orbit Data</button>
        <button onclick="resetView()">Reset View</button>

        <label>Speed: <span id="speedValue">1x</span></label>
        <input type="range" id="speedSlider" min="0" max="4" value="0" step="1"
               onchange="updateSpeed(this.value)">

        <label class="checkbox-label">
            <input type="checkbox" id="showGroundTracks" checked onchange="toggleGroundTracks()">
            Show Ground Tracks
        </label>

        <label class="checkbox-label">
            <input type="checkbox" id="showOrbits" checked onchange="toggleOrbits()">
            Show Orbit Paths
        </label>

        <label class="checkbox-label">
            <input type="checkbox" id="showLabels" checked onchange="toggleLabels()">
            Show Labels
        </label>

        <div id="status">Ready to load orbit data...</div>
    </div>

    <div id="infoBox">
        <span class="close" onclick="hideInfoBox()">&times;</span>
        <h4 id="satName">Satellite</h4>
        <div id="satInfo"></div>
    </div>

    <div id="cesiumContainer"></div>

    <script>
        // Speed multipliers: 1x, 10x, 60x, 600x, 3600x
        const speedMultipliers = [1, 10, 60, 600, 3600];
        const speedLabels = ['1x', '10x', '1min/s', '10min/s', '1hr/s'];

        // Initialize Cesium viewer with animation controls (no Ion token required)
        const viewer = new Cesium.Viewer('cesiumContainer', {
            animation: true,
            timeline: true,
            baseLayerPicker: false,
            geocoder: false,
            homeButton: true,
            infoBox: false,
            selectionIndicator: true,
            sceneModePicker: true,
            navigationHelpButton: false,
            imageryProvider: new Cesium.TileMapServiceImageryProvider({
                url: Cesium.buildModuleUrl('Assets/Textures/NaturalEarthII')
            })
        });

        // Remove terrain (use ellipsoid)
        viewer.scene.globe.depthTestAgainstTerrain = false;

        // Entity storage
        let satelliteEntities = [];
        let groundTrackEntities = [];
        let orbitEntities = [];
        let orbitData = null;

        // Satellite colors
        const colors = [
            Cesium.Color.RED,
            Cesium.Color.YELLOW,
            Cesium.Color.LIME,
            Cesium.Color.CYAN,
            Cesium.Color.BLUE,
            Cesium.Color.MAGENTA,
            Cesium.Color.WHITE,
            Cesium.Color.ORANGE,
            Cesium.Color.PINK,
            Cesium.Color.AQUA
        ];

        function resetView() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(0, 0, 25000000),
                orientation: {
                    heading: 0,
                    pitch: -Cesium.Math.PI_OVER_TWO,
                    roll: 0
                }
            });
        }

        function updateSpeed(value) {
            const multiplier = speedMultipliers[value];
            document.getElementById('speedValue').textContent = speedLabels[value];
            viewer.clock.multiplier = multiplier;
        }

        function toggleGroundTracks() {
            const show = document.getElementById('showGroundTracks').checked;
            groundTrackEntities.forEach(entity => {
                entity.show = show;
            });
        }

        function toggleOrbits() {
            const show = document.getElementById('showOrbits').checked;
            orbitEntities.forEach(entity => {
                entity.show = show;
            });
        }

        function toggleLabels() {
            const show = document.getElementById('showLabels').checked;
            satelliteEntities.forEach(entity => {
                if (entity.label) {
                    entity.label.show = show;
                }
            });
        }

        function hideInfoBox() {
            document.getElementById('infoBox').style.display = 'none';
        }

        function showSatelliteInfo(satellite, entity) {
            const infoBox = document.getElementById('infoBox');
            const nameEl = document.getElementById('satName');
            const infoEl = document.getElementById('satInfo');

            nameEl.textContent = satellite.name;

            // Get current position
            const time = viewer.clock.currentTime;
            const position = entity.position.getValue(time);

            if (position) {
                const cartographic = Cesium.Cartographic.fromCartesian(position);
                const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(2);
                const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(2);
                const alt = (cartographic.height / 1000).toFixed(1);

                infoEl.innerHTML = `
                    ID: ${satellite.id}<br>
                    Latitude: ${lat}&deg;<br>
                    Longitude: ${lon}&deg;<br>
                    Altitude: ${alt} km<br>
                    Points: ${satellite.positions.length}
                `;
            }

            infoBox.style.display = 'block';
        }

        // Convert Julian Date to Cesium JulianDate
        function jdToCesiumJD(jd) {
            // Julian Date to JavaScript Date
            // JD 2440587.5 = Unix epoch (Jan 1, 1970)
            const unixMs = (jd - 2440587.5) * 86400000;
            const jsDate = new Date(unixMs);
            return Cesium.JulianDate.fromDate(jsDate);
        }

        async function loadOrbitData() {
            const status = document.getElementById('status');
            status.textContent = 'Loading orbit data...';

            try {
                // Load the orbit JSON file
                const response = await fetch('../../orbit_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                orbitData = await response.json();

                // Clear existing entities
                satelliteEntities.forEach(e => viewer.entities.remove(e));
                groundTrackEntities.forEach(e => viewer.entities.remove(e));
                orbitEntities.forEach(e => viewer.entities.remove(e));
                satelliteEntities = [];
                groundTrackEntities = [];
                orbitEntities = [];

                // Get metadata
                const metadata = orbitData.metadata;
                const epochJD = metadata.epoch_jd;
                const duration = metadata.duration;
                const timeStep = metadata.time_step;

                // Set up clock with epoch times
                const startTime = jdToCesiumJD(epochJD);
                const stopTime = Cesium.JulianDate.addSeconds(startTime, duration, new Cesium.JulianDate());

                viewer.clock.startTime = startTime.clone();
                viewer.clock.stopTime = stopTime.clone();
                viewer.clock.currentTime = startTime.clone();
                viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
                viewer.clock.multiplier = 1;

                viewer.timeline.zoomTo(startTime, stopTime);

                // Process each satellite
                orbitData.satellites.forEach((satellite, idx) => {
                    const color = colors[idx % colors.length];

                    // Create SampledPositionProperty for animated position (ECI)
                    const positionProperty = new Cesium.SampledPositionProperty(
                        Cesium.ReferenceFrame.INERTIAL
                    );
                    positionProperty.setInterpolationOptions({
                        interpolationDegree: 3,
                        interpolationAlgorithm: Cesium.LagrangePolynomialApproximation
                    });

                    // Arrays for static orbit path and ground track
                    const orbitPositions = [];
                    const groundTrackPositions = [];

                    // Add position samples
                    satellite.positions.forEach(pos => {
                        const time = Cesium.JulianDate.addSeconds(
                            startTime, pos.time, new Cesium.JulianDate()
                        );

                        // ECI position for animated satellite
                        const eciPos = new Cesium.Cartesian3(
                            pos.eci.x, pos.eci.y, pos.eci.z
                        );
                        positionProperty.addSample(time, eciPos);
                        orbitPositions.push(eciPos);

                        // Geodetic position for ground track (at surface)
                        if (pos.geo) {
                            groundTrackPositions.push(
                                Cesium.Cartesian3.fromDegrees(
                                    pos.geo.lon, pos.geo.lat, 0
                                )
                            );
                        }
                    });

                    // Create animated satellite entity
                    const satEntity = viewer.entities.add({
                        name: satellite.name,
                        position: positionProperty,
                        point: {
                            pixelSize: 12,
                            color: color,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2
                        },
                        label: {
                            text: satellite.name,
                            font: '14px sans-serif',
                            fillColor: Cesium.Color.WHITE,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset: new Cesium.Cartesian2(0, -14),
                            show: document.getElementById('showLabels').checked
                        },
                        // Store satellite data for click handler
                        properties: {
                            satelliteData: satellite
                        }
                    });
                    satelliteEntities.push(satEntity);

                    // Create orbit path (ECI, shown in inertial frame)
                    const orbitEntity = viewer.entities.add({
                        name: satellite.name + ' Orbit',
                        polyline: {
                            positions: orbitPositions,
                            width: 1.5,
                            material: color.withAlpha(0.6),
                            arcType: Cesium.ArcType.NONE
                        },
                        show: document.getElementById('showOrbits').checked
                    });
                    orbitEntities.push(orbitEntity);

                    // Create ground track
                    if (groundTrackPositions.length > 0) {
                        const groundTrackEntity = viewer.entities.add({
                            name: satellite.name + ' Ground Track',
                            polyline: {
                                positions: groundTrackPositions,
                                width: 2,
                                material: color.withAlpha(0.5),
                                clampToGround: true
                            },
                            show: document.getElementById('showGroundTracks').checked
                        });
                        groundTrackEntities.push(groundTrackEntity);
                    }
                });

                // Set up click handler for satellite info
                viewer.screenSpaceEventHandler.setInputAction(function(click) {
                    const pickedObject = viewer.scene.pick(click.position);
                    if (Cesium.defined(pickedObject) && pickedObject.id) {
                        const entity = pickedObject.id;
                        // Find satellite data
                        const satData = orbitData.satellites.find(s => s.name === entity.name);
                        if (satData) {
                            showSatelliteInfo(satData, entity);
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

                status.textContent = `Loaded ${orbitData.satellites.length} satellites | Epoch: ${metadata.epoch_iso}`;

                // Zoom to show all satellites
                if (satelliteEntities.length > 0) {
                    viewer.zoomTo(viewer.entities);
                }

            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error('Error loading orbit data:', error);
            }
        }

        // Initial view
        resetView();

        // Try to load data automatically after viewer is ready
        viewer.scene.globe.tileLoadProgressEvent.addEventListener(function() {
            // Load once globe starts rendering
        });

        setTimeout(loadOrbitData, 1000);
    </script>
</body>
</html>
