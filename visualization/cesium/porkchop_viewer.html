<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Porkchop Plot - All-Domain Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%; height: 100%;
            background: #0a0e17;
            color: #c8cdd5;
            font-family: 'Consolas', 'Courier New', monospace;
            overflow: hidden;
        }

        /* ─── Layout ─────────────────────────────────────────── */
        #mainContainer {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #plotArea {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        #porkchopCanvas {
            background: #111;
            border: 1px solid #1e2a42;
            border-radius: 4px;
            cursor: crosshair;
        }

        /* ─── Side Panel ─────────────────────────────────────── */
        #sidePanel {
            width: 320px;
            background: #0d1320;
            border-left: 1px solid #1e2a42;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        #sidePanel h2 {
            font-size: 16px;
            color: #e8ecf2;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 11px;
            color: #5a6a80;
            margin-bottom: 18px;
        }

        .info-section {
            margin-bottom: 16px;
        }

        .info-section h3 {
            font-size: 11px;
            color: #4a9eff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #1a2235;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }

        .info-row .label { color: #6b7a90; font-size: 12px; }
        .info-row .value { color: #c8cdd5; font-size: 12px; text-align: right; }
        .info-row .value.green { color: #2ecc71; }
        .info-row .value.red { color: #e74c3c; }
        .info-row .value.cyan { color: #4a9eff; }
        .info-row .value.gold { color: #FFD700; }

        /* ─── Toggle Buttons ─────────────────────────────────── */
        .toggle-group {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }

        .toggle-group button {
            flex: 1;
            background: #1a2235;
            border: 1px solid #2a3f5f;
            color: #8a96a6;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            transition: all 0.15s;
        }

        .toggle-group button:hover {
            background: #243352;
            color: #c8cdd5;
        }

        .toggle-group button.active {
            background: #1e3a5f;
            border-color: #4a9eff;
            color: #4a9eff;
        }

        /* ─── Selection Details ──────────────────────────────── */
        #selectionDetails {
            display: none;
        }

        #selectionDetails.visible {
            display: block;
        }

        /* ─── Transfer Geometry Inset ────────────────────────── */
        #geometryInset {
            margin-top: 16px;
            border: 1px solid #1e2a42;
            border-radius: 4px;
            background: #111;
        }

        #geometryCanvas {
            width: 100%;
            height: 250px;
        }

        /* ─── Tooltip ────────────────────────────────────────── */
        #tooltip {
            position: absolute;
            background: rgba(10, 14, 23, 0.95);
            border: 1px solid #2a3f5f;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 11px;
            pointer-events: none;
            display: none;
            z-index: 200;
            max-width: 220px;
        }

        #tooltip .tt-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 1px 0;
        }

        #tooltip .tt-label { color: #6b7a90; }
        #tooltip .tt-value { color: #c8cdd5; }

        /* ─── Loading ────────────────────────────────────────── */
        #loadingOverlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        #loadingOverlay.hidden { display: none; }

        #loadingOverlay .spinner {
            width: 40px; height: 40px;
            border: 3px solid #1e2a42;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #loadingOverlay .msg {
            color: #4a9eff;
            font-size: 14px;
        }

        #loadingOverlay .sub-msg {
            color: #5a6a80;
            font-size: 11px;
            margin-top: 6px;
        }

        /* ─── Generate Panel (when no data file) ─────────────── */
        #generatePanel {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        #generatePanel.visible { display: block; }

        #generatePanel h3 {
            color: #e8ecf2;
            margin-bottom: 8px;
        }

        #generatePanel p {
            color: #6b7a90;
            font-size: 12px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        #generatePanel button {
            background: #1e3a5f;
            border: 1px solid #4a9eff;
            color: #4a9eff;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.15s;
        }

        #generatePanel button:hover {
            background: #2a4a7f;
        }

        #generatePanel select {
            background: #1a2235;
            border: 1px solid #2a3f5f;
            color: #c8cdd5;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            margin: 0 6px 16px;
        }

        .gen-row {
            margin-bottom: 12px;
        }

        .gen-row label {
            color: #6b7a90;
            font-size: 11px;
            display: block;
            margin-bottom: 4px;
        }

        .gen-row input {
            background: #1a2235;
            border: 1px solid #2a3f5f;
            color: #c8cdd5;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            width: 100px;
        }

        /* ─── Keyboard Help ──────────────────────────────────── */
        #helpOverlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 14, 23, 0.95);
            border: 1px solid #2a3f5f;
            border-radius: 10px;
            padding: 24px 30px;
            z-index: 400;
            display: none;
            min-width: 280px;
        }

        #helpOverlay.visible { display: block; }

        #helpOverlay h3 {
            color: #e8ecf2;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .help-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
        }

        .help-row .key { color: #4a9eff; font-weight: 600; min-width: 60px; }
        .help-row .desc { color: #8a96a6; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="msg">Loading Porkchop Data...</div>
        <div class="sub-msg">interplanetary_porkchop.json</div>
    </div>

    <div id="mainContainer">
        <!-- Plot Area -->
        <div id="plotArea">
            <canvas id="porkchopCanvas" width="900" height="700"></canvas>
            <div id="tooltip"></div>

            <div id="generatePanel">
                <h3>No Porkchop Data Found</h3>
                <p>No interplanetary_porkchop.json was found.<br>
                   You can generate one using the C++ backend or compute one in-browser.</p>

                <div class="gen-row">
                    <label>Departure Planet</label>
                    <select id="genDeparture">
                        <option value="EARTH" selected>Earth</option>
                        <option value="VENUS">Venus</option>
                        <option value="MARS">Mars</option>
                    </select>
                </div>
                <div class="gen-row">
                    <label>Arrival Planet</label>
                    <select id="genArrival">
                        <option value="VENUS">Venus</option>
                        <option value="MARS" selected>Mars</option>
                        <option value="JUPITER">Jupiter</option>
                    </select>
                </div>
                <div class="gen-row">
                    <label>Launch Window Start (YYYY)</label>
                    <input id="genYear" type="number" value="2026" min="2000" max="2050">
                </div>
                <div class="gen-row">
                    <label>Grid Resolution</label>
                    <select id="genRes">
                        <option value="30">30x30 (fast)</option>
                        <option value="50" selected>50x50 (default)</option>
                        <option value="80">80x80 (detailed)</option>
                    </select>
                </div>

                <button id="btnGenerate">Compute Porkchop Plot</button>
            </div>
        </div>

        <!-- Side Panel -->
        <div id="sidePanel">
            <h2>Porkchop Plot</h2>
            <div class="subtitle">Interplanetary Transfer Analysis</div>

            <!-- Plot Mode Toggle -->
            <div class="toggle-group">
                <button id="btnC3" class="active">C3 (km\u00B2/s\u00B2)</button>
                <button id="btnDV">Total \u0394V</button>
            </div>

            <!-- Optimal Transfer -->
            <div class="info-section" id="optimalSection">
                <h3>Optimal Transfer</h3>
                <div class="info-row">
                    <span class="label">Route</span>
                    <span class="value cyan" id="optRoute">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Launch</span>
                    <span class="value green" id="optLaunch">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Arrival</span>
                    <span class="value red" id="optArrival">--</span>
                </div>
                <div class="info-row">
                    <span class="label">TOF</span>
                    <span class="value" id="optTOF">--</span>
                </div>
                <div class="info-row">
                    <span class="label">C3 Departure</span>
                    <span class="value gold" id="optC3">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Total \u0394V</span>
                    <span class="value gold" id="optDV">--</span>
                </div>
            </div>

            <!-- Selected Point -->
            <div class="info-section" id="selectionDetails">
                <h3>Selected Transfer</h3>
                <div class="info-row">
                    <span class="label">Launch</span>
                    <span class="value green" id="selLaunch">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Arrival</span>
                    <span class="value red" id="selArrival">--</span>
                </div>
                <div class="info-row">
                    <span class="label">TOF</span>
                    <span class="value" id="selTOF">--</span>
                </div>
                <div class="info-row">
                    <span class="label">C3</span>
                    <span class="value" id="selC3">--</span>
                </div>
                <div class="info-row">
                    <span class="label">\u0394V</span>
                    <span class="value" id="selDV">--</span>
                </div>
            </div>

            <!-- Grid Info -->
            <div class="info-section">
                <h3>Grid Info</h3>
                <div class="info-row">
                    <span class="label">Launch Range</span>
                    <span class="value" id="gridLaunchRange">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Arrival Range</span>
                    <span class="value" id="gridArrivalRange">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Grid Points</span>
                    <span class="value" id="gridPoints">--</span>
                </div>
                <div class="info-row">
                    <span class="label">Valid Solutions</span>
                    <span class="value" id="gridValid">--</span>
                </div>
            </div>

            <!-- Transfer Geometry Inset -->
            <div id="geometryInset">
                <canvas id="geometryCanvas" width="280" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Help Overlay -->
    <div id="helpOverlay">
        <h3>Keyboard Controls</h3>
        <div class="help-row"><span class="key">C / D</span><span class="desc">Toggle C3 / \u0394V mode</span></div>
        <div class="help-row"><span class="key">H</span><span class="desc">Toggle this help</span></div>
        <div class="help-row"><span class="key">Esc</span><span class="desc">Clear selection</span></div>
    </div>

    <!-- Dependencies -->
    <script src="js/framework/solar_system_engine.js"></script>
    <script src="js/framework/porkchop_renderer.js"></script>
    <script>
    (function() {
        'use strict';

        var SSE = SolarSystemEngine;
        var canvas = document.getElementById('porkchopCanvas');
        var ctx = canvas.getContext('2d');
        var geoCanvas = document.getElementById('geometryCanvas');
        var geoCtx = geoCanvas.getContext('2d');

        var porkchopData = null;
        var selectedPoint = null;
        var useC3 = true;

        // ═══════════════════════════════════════════════════════════════
        // Resize Canvas to Fit
        // ═══════════════════════════════════════════════════════════════
        function resizeCanvas() {
            var plotArea = document.getElementById('plotArea');
            var maxW = plotArea.clientWidth - 40;
            var maxH = plotArea.clientHeight - 40;
            var aspect = 900 / 700;

            var w, h;
            if (maxW / maxH > aspect) {
                h = maxH;
                w = h * aspect;
            } else {
                w = maxW;
                h = w / aspect;
            }

            canvas.width = Math.floor(w);
            canvas.height = Math.floor(h);

            if (porkchopData) {
                redraw();
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // Load Porkchop Data
        // ═══════════════════════════════════════════════════════════════
        function loadData() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'interplanetary_porkchop.json', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        porkchopData = JSON.parse(xhr.responseText);
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        onDataLoaded();
                    } catch (e) {
                        console.error('Failed to parse porkchop data:', e);
                        showGeneratePanel();
                    }
                } else {
                    showGeneratePanel();
                }
            };
            xhr.onerror = function() {
                showGeneratePanel();
            };
            xhr.send();
        }

        function showGeneratePanel() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('generatePanel').classList.add('visible');
        }

        // ═══════════════════════════════════════════════════════════════
        // In-Browser Porkchop Computation
        // ═══════════════════════════════════════════════════════════════
        function computePorkchop(depPlanet, arrPlanet, startYear, gridRes) {
            var grid = [];
            var depKey = depPlanet.toUpperCase();
            var arrKey = arrPlanet.toUpperCase();

            // Synodic period estimate for launch window
            var depPeriod = 365.25 * Math.pow(SSE.PLANETS[depKey].sma_au, 1.5);
            var arrPeriod = 365.25 * Math.pow(SSE.PLANETS[arrKey].sma_au, 1.5);
            var synodicPeriod = Math.abs(1 / (1 / depPeriod - 1 / arrPeriod));

            var launchStart = SSE.calendarToJD(startYear, 1, 1);
            var launchEnd = launchStart + synodicPeriod * 1.2;

            // TOF range based on Hohmann estimate
            var a_transfer = (SSE.PLANETS[depKey].sma_au + SSE.PLANETS[arrKey].sma_au) / 2;
            var hohmannTOF = Math.PI * Math.sqrt(Math.pow(a_transfer * SSE.AU, 3) / SSE.MU_SUN) / 86400;
            var tofMin = hohmannTOF * 0.4;
            var tofMax = hohmannTOF * 2.0;

            var arrivalStart = launchStart + tofMin;
            var arrivalEnd = launchEnd + tofMax;

            var ls = gridRes;
            var as = gridRes;
            var dLaunch = (launchEnd - launchStart) / ls;
            var dArrival = (arrivalEnd - arrivalStart) / as;

            var bestC3 = Infinity;
            var bestDV = Infinity;
            var optimal = null;

            for (var li = 0; li < ls; li++) {
                var lj = launchStart + (li + 0.5) * dLaunch;
                var depPos = SSE.getPlanetPositionHCI(depKey, lj);
                var depVel = SSE.getPlanetVelocityHCI(depKey, lj);

                for (var ai = 0; ai < as; ai++) {
                    var aj = arrivalStart + (ai + 0.5) * dArrival;
                    var tof = (aj - lj) * 86400;  // seconds

                    if (tof <= 0) {
                        grid.push({ lj: lj, aj: aj, c3: -1, dv: -1, v: false });
                        continue;
                    }

                    var arrPos = SSE.getPlanetPositionHCI(arrKey, aj);
                    var arrVel = SSE.getPlanetVelocityHCI(arrKey, aj);

                    // Compute transfer velocity using simple vis-viva
                    var r1 = SSE.vecMag(depPos);
                    var r2 = SSE.vecMag(arrPos);

                    // Approximate transfer semi-major axis
                    var chord = SSE.vecMag(SSE.vecSub(arrPos, depPos));

                    // Use Battin's approximation for Lambert: a ~ (r1 + r2 + chord) / 4
                    var s = (r1 + r2 + chord) / 2;
                    var a_est = s / 2;

                    // Check if geometry is reasonable
                    if (a_est <= 0 || !isFinite(a_est)) {
                        grid.push({ lj: lj, aj: aj, c3: -1, dv: -1, v: false });
                        continue;
                    }

                    // Vis-viva for departure and arrival speeds
                    var v1_sq = SSE.MU_SUN * (2 / r1 - 1 / a_est);
                    var v2_sq = SSE.MU_SUN * (2 / r2 - 1 / a_est);

                    if (v1_sq < 0 || v2_sq < 0) {
                        grid.push({ lj: lj, aj: aj, c3: -1, dv: -1, v: false });
                        continue;
                    }

                    var v1 = Math.sqrt(v1_sq);
                    var v2 = Math.sqrt(v2_sq);

                    // V-infinity at departure and arrival
                    var depSpeed = SSE.vecMag(depVel);
                    var arrSpeed = SSE.vecMag(arrVel);

                    var vinf_dep = Math.abs(v1 - depSpeed);
                    var vinf_arr = Math.abs(v2 - arrSpeed);

                    var c3 = vinf_dep * vinf_dep / 1e6;  // km^2/s^2
                    var dv = (vinf_dep + vinf_arr) / 1000;  // km/s total

                    if (!isFinite(c3) || c3 < 0) {
                        grid.push({ lj: lj, aj: aj, c3: -1, dv: -1, v: false });
                        continue;
                    }

                    grid.push({ lj: lj, aj: aj, c3: c3, dv: dv, v: true });

                    if (c3 < bestC3) {
                        bestC3 = c3;
                        bestDV = dv;
                        optimal = {
                            launch_jd: lj,
                            arrival_jd: aj,
                            c3_departure: c3,
                            total_delta_v: dv * 1000  // m/s
                        };
                    }
                }
            }

            return {
                grid: grid,
                launch_jd_start: launchStart,
                launch_jd_end: launchEnd,
                arrival_jd_start: arrivalStart,
                arrival_jd_end: arrivalEnd,
                launch_steps: ls,
                arrival_steps: as,
                departure_planet: SSE.PLANETS[depKey].name,
                arrival_planet: SSE.PLANETS[arrKey].name,
                optimal: optimal
            };
        }

        // ═══════════════════════════════════════════════════════════════
        // Data Loaded - Initialize Display
        // ═══════════════════════════════════════════════════════════════
        function onDataLoaded() {
            if (!porkchopData) return;

            // Populate info panel
            var dep = porkchopData.departure_planet || 'Earth';
            var arr = porkchopData.arrival_planet || 'Mars';
            document.getElementById('optRoute').textContent = dep + ' -> ' + arr;

            if (porkchopData.optimal) {
                var opt = porkchopData.optimal;
                document.getElementById('optLaunch').textContent = SSE.jdToDateString(opt.launch_jd);
                document.getElementById('optArrival').textContent = SSE.jdToDateString(opt.arrival_jd);
                document.getElementById('optTOF').textContent =
                    (opt.arrival_jd - opt.launch_jd).toFixed(1) + ' days';
                document.getElementById('optC3').textContent =
                    opt.c3_departure.toFixed(2) + ' km\u00B2/s\u00B2';
                document.getElementById('optDV').textContent =
                    (opt.total_delta_v / 1000).toFixed(3) + ' km/s';
            }

            // Grid info
            document.getElementById('gridLaunchRange').textContent =
                SSE.jdToDateString(porkchopData.launch_jd_start) + ' to ' +
                SSE.jdToDateString(porkchopData.launch_jd_end);
            document.getElementById('gridArrivalRange').textContent =
                SSE.jdToDateString(porkchopData.arrival_jd_start) + ' to ' +
                SSE.jdToDateString(porkchopData.arrival_jd_end);
            document.getElementById('gridPoints').textContent =
                porkchopData.grid.length;
            document.getElementById('gridValid').textContent =
                porkchopData.grid.filter(function(p) { return p.v; }).length;

            resizeCanvas();
            redraw();
            drawGeometry(porkchopData.optimal);
        }

        // ═══════════════════════════════════════════════════════════════
        // Render
        // ═══════════════════════════════════════════════════════════════
        function redraw() {
            if (!porkchopData) return;
            PorkchopRenderer.render(canvas, porkchopData, { useC3: useC3 });

            if (selectedPoint) {
                PorkchopRenderer.drawSelection(canvas, porkchopData, selectedPoint);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // Transfer Geometry Inset
        // ═══════════════════════════════════════════════════════════════
        function drawGeometry(point) {
            if (!point || !porkchopData) return;

            var gw = geoCanvas.width;
            var gh = geoCanvas.height;
            geoCtx.fillStyle = '#111';
            geoCtx.fillRect(0, 0, gw, gh);

            var depKey = (porkchopData.departure_planet || 'Earth').toUpperCase();
            var arrKey = (porkchopData.arrival_planet || 'Mars').toUpperCase();

            var lj = point.launch_jd || point.lj;
            var aj = point.arrival_jd || point.aj;

            if (!lj || !aj) return;

            // Get planet positions at departure and arrival
            var depPos = SSE.getPlanetPositionHCI(depKey, lj);
            var arrPos = SSE.getPlanetPositionHCI(arrKey, aj);

            // Get orbit paths for both planets
            var depOrbit = SSE.getOrbitPath(depKey, lj, 120);
            var arrOrbit = SSE.getOrbitPath(arrKey, lj, 120);

            // Determine scale: fit the arrival orbit with margin
            var maxR = 0;
            for (var i = 0; i < arrOrbit.length; i++) {
                var r = Math.sqrt(arrOrbit[i].x * arrOrbit[i].x + arrOrbit[i].y * arrOrbit[i].y);
                if (r > maxR) maxR = r;
            }
            if (maxR === 0) maxR = SSE.AU * 2;

            var cx = gw / 2;
            var cy = gh / 2;
            var scale = (Math.min(gw, gh) / 2 - 20) / maxR;

            // Helper: project to 2D (top-down ecliptic view)
            function proj(pos) {
                return { x: cx + pos.x * scale, y: cy - pos.y * scale };
            }

            // Draw departure orbit
            geoCtx.strokeStyle = SSE.PLANETS[depKey].color + '60';
            geoCtx.lineWidth = 1;
            geoCtx.beginPath();
            for (var i = 0; i < depOrbit.length; i++) {
                var p = proj(depOrbit[i]);
                if (i === 0) geoCtx.moveTo(p.x, p.y);
                else geoCtx.lineTo(p.x, p.y);
            }
            geoCtx.stroke();

            // Draw arrival orbit
            geoCtx.strokeStyle = SSE.PLANETS[arrKey].color + '60';
            geoCtx.beginPath();
            for (var i = 0; i < arrOrbit.length; i++) {
                var p = proj(arrOrbit[i]);
                if (i === 0) geoCtx.moveTo(p.x, p.y);
                else geoCtx.lineTo(p.x, p.y);
            }
            geoCtx.stroke();

            // Draw transfer arc (straight line approximation)
            var dp = proj(depPos);
            var ap = proj(arrPos);
            geoCtx.strokeStyle = '#FFD700';
            geoCtx.lineWidth = 2;
            geoCtx.setLineDash([6, 3]);
            geoCtx.beginPath();
            geoCtx.moveTo(dp.x, dp.y);

            // Add curvature: use midpoint offset for arc effect
            var midX = (depPos.x + arrPos.x) / 2;
            var midY = (depPos.y + arrPos.y) / 2;
            // Perpendicular offset for curvature
            var dx = arrPos.x - depPos.x;
            var dy = arrPos.y - depPos.y;
            var len = Math.sqrt(dx * dx + dy * dy);
            var perpX = -dy / len * len * 0.15;
            var perpY = dx / len * len * 0.15;
            var cp = proj({ x: midX + perpX, y: midY + perpY, z: 0 });
            geoCtx.quadraticCurveTo(cp.x, cp.y, ap.x, ap.y);
            geoCtx.stroke();
            geoCtx.setLineDash([]);

            // Sun
            geoCtx.fillStyle = '#FFD700';
            geoCtx.beginPath();
            geoCtx.arc(cx, cy, 4, 0, 2 * Math.PI);
            geoCtx.fill();

            // Departure planet
            geoCtx.fillStyle = '#2ecc71';
            geoCtx.beginPath();
            geoCtx.arc(dp.x, dp.y, 5, 0, 2 * Math.PI);
            geoCtx.fill();
            geoCtx.fillStyle = '#2ecc71';
            geoCtx.font = '9px monospace';
            geoCtx.textAlign = 'center';
            geoCtx.fillText(SSE.PLANETS[depKey].name, dp.x, dp.y - 10);

            // Arrival planet
            geoCtx.fillStyle = '#e74c3c';
            geoCtx.beginPath();
            geoCtx.arc(ap.x, ap.y, 5, 0, 2 * Math.PI);
            geoCtx.fill();
            geoCtx.fillStyle = '#e74c3c';
            geoCtx.fillText(SSE.PLANETS[arrKey].name, ap.x, ap.y - 10);

            // Label
            geoCtx.fillStyle = '#5a6a80';
            geoCtx.font = '9px monospace';
            geoCtx.textAlign = 'left';
            geoCtx.fillText('Ecliptic (top-down)', 5, gh - 5);
        }

        // ═══════════════════════════════════════════════════════════════
        // Mouse Interaction
        // ═══════════════════════════════════════════════════════════════
        var tooltipEl = document.getElementById('tooltip');

        canvas.addEventListener('mousemove', function(e) {
            if (!porkchopData) return;

            var rect = canvas.getBoundingClientRect();
            var x = (e.clientX - rect.left) * (canvas.width / rect.width);
            var y = (e.clientY - rect.top) * (canvas.height / rect.height);

            var point = PorkchopRenderer.hitTest(canvas, porkchopData, x, y);
            if (point) {
                tooltipEl.style.display = 'block';
                tooltipEl.style.left = (e.clientX + 15) + 'px';
                tooltipEl.style.top = (e.clientY - 10) + 'px';

                var tof = (point.aj - point.lj);
                tooltipEl.innerHTML =
                    '<div class="tt-row"><span class="tt-label">Launch</span><span class="tt-value">' + SSE.jdToDateString(point.lj) + '</span></div>' +
                    '<div class="tt-row"><span class="tt-label">Arrive</span><span class="tt-value">' + SSE.jdToDateString(point.aj) + '</span></div>' +
                    '<div class="tt-row"><span class="tt-label">TOF</span><span class="tt-value">' + tof.toFixed(0) + ' d</span></div>' +
                    '<div class="tt-row"><span class="tt-label">C3</span><span class="tt-value">' + point.c3.toFixed(2) + '</span></div>' +
                    '<div class="tt-row"><span class="tt-label">\u0394V</span><span class="tt-value">' + point.dv.toFixed(2) + ' km/s</span></div>';
            } else {
                tooltipEl.style.display = 'none';
            }
        });

        canvas.addEventListener('mouseleave', function() {
            tooltipEl.style.display = 'none';
        });

        canvas.addEventListener('click', function(e) {
            if (!porkchopData) return;

            var rect = canvas.getBoundingClientRect();
            var x = (e.clientX - rect.left) * (canvas.width / rect.width);
            var y = (e.clientY - rect.top) * (canvas.height / rect.height);

            var point = PorkchopRenderer.hitTest(canvas, porkchopData, x, y);
            if (point) {
                selectedPoint = point;
                redraw();

                // Update selection panel
                var selEl = document.getElementById('selectionDetails');
                selEl.classList.add('visible');
                document.getElementById('selLaunch').textContent = SSE.jdToDateString(point.lj);
                document.getElementById('selArrival').textContent = SSE.jdToDateString(point.aj);
                document.getElementById('selTOF').textContent = (point.aj - point.lj).toFixed(1) + ' days';
                document.getElementById('selC3').textContent = point.c3.toFixed(2) + ' km\u00B2/s\u00B2';
                document.getElementById('selDV').textContent = point.dv.toFixed(2) + ' km/s';

                // Update geometry inset
                drawGeometry({ launch_jd: point.lj, arrival_jd: point.aj });
            }
        });

        // ═══════════════════════════════════════════════════════════════
        // Toggle C3 / DV
        // ═══════════════════════════════════════════════════════════════
        function setC3Mode() {
            useC3 = true;
            document.getElementById('btnC3').classList.add('active');
            document.getElementById('btnDV').classList.remove('active');
            redraw();
        }

        function setDVMode() {
            useC3 = false;
            document.getElementById('btnDV').classList.add('active');
            document.getElementById('btnC3').classList.remove('active');
            redraw();
        }

        document.getElementById('btnC3').addEventListener('click', setC3Mode);
        document.getElementById('btnDV').addEventListener('click', setDVMode);

        // ═══════════════════════════════════════════════════════════════
        // Generate Button
        // ═══════════════════════════════════════════════════════════════
        document.getElementById('btnGenerate').addEventListener('click', function() {
            var dep = document.getElementById('genDeparture').value;
            var arr = document.getElementById('genArrival').value;
            var year = parseInt(document.getElementById('genYear').value);
            var res = parseInt(document.getElementById('genRes').value);

            if (dep === arr) {
                alert('Departure and arrival planets must be different.');
                return;
            }

            document.getElementById('generatePanel').classList.remove('visible');
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.querySelector('#loadingOverlay .msg').textContent = 'Computing porkchop plot...';
            document.querySelector('#loadingOverlay .sub-msg').textContent =
                SSE.PLANETS[dep].name + ' -> ' + SSE.PLANETS[arr].name + ' (' + res + 'x' + res + ')';

            // Use setTimeout to let the UI update before heavy computation
            setTimeout(function() {
                porkchopData = computePorkchop(dep, arr, year, res);
                document.getElementById('loadingOverlay').classList.add('hidden');
                onDataLoaded();
            }, 100);
        });

        // ═══════════════════════════════════════════════════════════════
        // Keyboard
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('keydown', function(e) {
            switch (e.key) {
                case 'c':
                case 'C':
                    setC3Mode();
                    break;
                case 'd':
                case 'D':
                    setDVMode();
                    break;
                case 'h':
                case 'H':
                    document.getElementById('helpOverlay').classList.toggle('visible');
                    break;
                case 'Escape':
                    selectedPoint = null;
                    document.getElementById('selectionDetails').classList.remove('visible');
                    redraw();
                    if (porkchopData && porkchopData.optimal) {
                        drawGeometry(porkchopData.optimal);
                    }
                    break;
            }
        });

        // ═══════════════════════════════════════════════════════════════
        // Window Resize
        // ═══════════════════════════════════════════════════════════════
        window.addEventListener('resize', resizeCanvas);

        // ═══════════════════════════════════════════════════════════════
        // Startup
        // ═══════════════════════════════════════════════════════════════
        resizeCanvas();
        loadData();

    })();
    </script>
</body>
</html>
