<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurable Nuclear Detonation - All Domain Sim</title>

    <!-- Cesium -->
    <link rel="stylesheet" href="lib/Cesium/Widgets/widgets.css">
    <script src="lib/Cesium/Cesium.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }

        #cesiumContainer {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
        }

        .panel {
            position: absolute;
            background: rgba(5, 10, 20, 0.88);
            border: 1px solid #1a3a6a;
            border-radius: 6px;
            padding: 12px 14px;
            color: #88bbff;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 20;
            pointer-events: auto;
        }

        .panel h3 {
            color: #55aaff;
            font-size: 11px;
            margin-bottom: 6px;
            border-bottom: 1px solid #1a3060;
            padding-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Controls panel - top left */
        #controls {
            top: 10px; left: 10px; width: 270px;
        }

        #controls button {
            display: inline-block;
            background: #0a1a30;
            border: 1px solid #2050a0;
            border-radius: 4px;
            color: #66aaff;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
            margin: 2px 1px;
            transition: background 0.15s;
        }
        #controls button:hover { background: #102850; }
        #controls button.active { background: #1a4080; border-color: #4488ff; color: #aaddff; }
        #controls button.danger {
            border-color: #aa2020;
            color: #ff6644;
        }
        #controls button.danger:hover { background: #301010; }
        #controls button.danger.active {
            background: #401515;
            border-color: #ff4422;
            color: #ff8866;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 4px rgba(255,50,20,0.3); }
            50% { box-shadow: 0 0 12px rgba(255,50,20,0.6); }
        }

        .ctrl-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 4px 0;
        }

        .ctrl-label { color: #4488bb; font-size: 10px; }
        .ctrl-value { color: #88ccff; }

        /* Detonation config panel - below controls */
        #detonationConfig {
            top: 10px; left: 290px; width: 260px;
        }

        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 4px 0;
        }
        .input-row label {
            color: #4488bb;
            font-size: 10px;
            min-width: 65px;
        }
        .input-row input, .input-row select {
            background: #0a1525;
            border: 1px solid #1a3060;
            border-radius: 3px;
            color: #88ccff;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 3px 6px;
            width: 140px;
            text-align: right;
        }
        .input-row input:focus {
            outline: none;
            border-color: #3070c0;
        }
        .input-row input[type="range"] {
            -webkit-appearance: none;
            background: #0a1525;
            height: 4px;
            border-radius: 2px;
            padding: 0;
        }
        .input-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #4488ff;
            cursor: pointer;
        }

        .computed-params {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #1a3060;
        }
        .computed-params .data-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        .param-label { color: #886644; font-size: 10px; }
        .param-value { color: #ccaa66; font-size: 10px; }
        .param-value.warn { color: #ff8844; }
        .param-value.good { color: #44cc88; }

        /* Telemetry panel - right side */
        #telemetry {
            top: 10px; right: 10px; width: 230px;
            max-height: calc(100vh - 30px);
            overflow-y: auto;
        }

        .sat-block {
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #0d1f3a;
        }
        .sat-block:last-child { border-bottom: none; }

        .sat-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 1px 0;
            line-height: 1.4;
        }
        .data-label { color: #4477aa; }
        .data-value { color: #88ccff; text-align: right; }
        .data-value.warn { color: #ffcc44; }
        .data-value.alert { color: #ff5533; }

        .dose-bar {
            height: 4px;
            background: #0a1525;
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }
        .dose-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Cross-section canvas - bottom left */
        #crossSectionWrap {
            position: absolute;
            bottom: 10px; left: 10px;
            z-index: 20;
        }
        #crossSectionLabel {
            color: #55aaff;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        #crossSection {
            border: 1px solid #1a3a6a;
            border-radius: 4px;
            background: #000;
        }

        /* Event log - bottom right */
        #eventLog {
            bottom: 10px; right: 10px; width: 340px;
            max-height: 180px;
            overflow-y: auto;
            font-size: 10px;
        }
        #eventLog .log-entry {
            margin: 2px 0;
            line-height: 1.3;
        }
        .log-time { color: #336699; }
        .log-msg { color: #77aabb; }
        .log-msg.alert { color: #ff8844; }
        .log-msg.starfish { color: #ff5533; }

        /* Status bar - top center */
        #statusBar {
            position: absolute;
            top: 8px; left: 50%;
            transform: translateX(-50%);
            background: rgba(5, 10, 20, 0.85);
            border: 1px solid #1a3a6a;
            border-radius: 4px;
            padding: 5px 18px;
            color: #88ccff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            z-index: 20;
            text-align: center;
            white-space: nowrap;
        }

        /* Help overlay */
        #helpOverlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(5, 10, 25, 0.95);
            border: 1px solid #2060b0;
            border-radius: 8px;
            padding: 20px 30px;
            color: #88ccff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 100;
            display: none;
            min-width: 420px;
        }
        #helpOverlay h2 {
            color: #55aaff;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .help-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .help-key {
            color: #ffcc44;
            min-width: 80px;
        }
        .help-desc { color: #77aabb; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- Status bar -->
    <div id="statusBar">CONFIGURABLE NUCLEAR DETONATION</div>

    <!-- Controls panel -->
    <div id="controls" class="panel">
        <h3>Simulation</h3>
        <div class="ctrl-row">
            <button id="btnPause">&#9654; Play</button>
            <button id="btnReset">Reset</button>
        </div>
        <div class="ctrl-row">
            <span class="ctrl-label">WARP</span>
            <span>
                <button id="btnWarpDn">-</button>
                <span id="warpDisplay" class="ctrl-value">1x</span>
                <button id="btnWarpUp">+</button>
            </span>
        </div>
        <div style="margin-top:8px;">
            <button id="btnDetonate" class="danger">DETONATE</button>
        </div>
        <div style="margin-top:6px;">
            <label style="cursor:pointer; color:#4488bb; font-size:10px;">
                <input type="checkbox" id="chkFieldLines" checked> Field Lines
            </label>
        </div>
        <div>
            <label style="cursor:pointer; color:#4488bb; font-size:10px;">
                <input type="checkbox" id="chkBeltCloud" checked> Belt Cloud
            </label>
        </div>
        <div class="ctrl-row" style="margin-top:6px;">
            <span class="ctrl-label">SIM TIME</span>
            <span id="simTimeDisplay" class="ctrl-value">0d 00:00:00</span>
        </div>
        <div class="ctrl-row" id="detonationTimeRow" style="display:none;">
            <span class="ctrl-label">T+ DETONATE</span>
            <span id="detonationTimeDisplay" class="ctrl-value" style="color:#ff8844;">—</span>
        </div>
    </div>

    <!-- Detonation configuration panel -->
    <div id="detonationConfig" class="panel">
        <h3>Detonation Parameters</h3>
        <div class="input-row">
            <label>Altitude</label>
            <input type="number" id="inputAlt" value="2000" min="50" max="50000" step="50">
        </div>
        <div class="input-row">
            <label></label>
            <input type="range" id="sliderAlt" min="50" max="50000" value="2000" step="50">
        </div>
        <div class="input-row" style="margin-top:2px;">
            <label style="font-size:9px; color:#335577;">km</label>
            <span style="font-size:9px; color:#335577;">50 km — 50,000 km (7.8 R<sub>E</sub>)</span>
        </div>

        <div class="input-row" style="margin-top:6px;">
            <label>Latitude</label>
            <input type="number" id="inputLat" value="16.7" min="-90" max="90" step="0.1">
        </div>
        <div class="input-row">
            <label>Longitude</label>
            <input type="number" id="inputLon" value="-169.5" min="-180" max="180" step="0.1">
        </div>

        <div class="input-row" style="margin-top:6px;">
            <label>Yield</label>
            <select id="inputYield">
                <option value="20000">20 kT (W-76)</option>
                <option value="100000">100 kT</option>
                <option value="475000">475 kT (W-88)</option>
                <option value="1400000" selected>1.4 MT (Starfish)</option>
                <option value="5000000">5 MT</option>
                <option value="25000000">25 MT</option>
                <option value="50000000">50 MT (Tsar Bomba)</option>
            </select>
        </div>

        <div class="input-row" style="margin-top:6px;">
            <label>Preset</label>
            <select id="presetSelect">
                <option value="custom">Custom</option>
                <option value="starfish" selected>Starfish Prime (2000 km)</option>
                <option value="starfish_hist">Starfish Historical (400 km)</option>
                <option value="low_leo">Low LEO (300 km)</option>
                <option value="inner_belt">Inner Belt (1500 km)</option>
                <option value="slot">Slot Region (8000 km)</option>
                <option value="outer_belt">Outer Belt (20000 km)</option>
                <option value="geo">Near GEO (35000 km)</option>
                <option value="polar">Polar (1000 km, 80N)</option>
                <option value="equatorial">Equatorial (2000 km, 0N)</option>
            </select>
        </div>

        <!-- Computed injection parameters (read-only) -->
        <div class="computed-params">
            <div class="data-row">
                <span class="param-label">Injection L</span>
                <span class="param-value" id="paramL">—</span>
            </div>
            <div class="data-row">
                <span class="param-label">L-spread (sigma)</span>
                <span class="param-value" id="paramSigma">—</span>
            </div>
            <div class="data-row">
                <span class="param-label">Peak flux</span>
                <span class="param-value" id="paramFlux">—</span>
            </div>
            <div class="data-row">
                <span class="param-label">Trapping</span>
                <span class="param-value" id="paramTrap">—</span>
            </div>
            <div class="data-row">
                <span class="param-label">Regime</span>
                <span class="param-value" id="paramRegime">—</span>
            </div>
        </div>
    </div>

    <!-- Telemetry panel -->
    <div id="telemetry" class="panel">
        <h3>Satellite Telemetry</h3>
        <div id="telemetryContent"></div>
    </div>

    <!-- Cross-section -->
    <div id="crossSectionWrap">
        <div id="crossSectionLabel">Meridional Cross-Section (Log Flux)</div>
        <canvas id="crossSection" width="400" height="300"></canvas>
    </div>

    <!-- Event log -->
    <div id="eventLog" class="panel">
        <h3>Event Log</h3>
        <div id="eventLogContent"></div>
    </div>

    <!-- Help overlay -->
    <div id="helpOverlay">
        <h2>KEYBOARD CONTROLS</h2>
        <div class="help-row"><span class="help-key">Space</span><span class="help-desc">Pause / Resume</span></div>
        <div class="help-row"><span class="help-key">+ / -</span><span class="help-desc">Time warp up / down</span></div>
        <div class="help-row"><span class="help-key">D</span><span class="help-desc">Detonate with current params</span></div>
        <div class="help-row"><span class="help-key">R</span><span class="help-desc">Reset simulation</span></div>
        <div class="help-row"><span class="help-key">F</span><span class="help-desc">Toggle field lines</span></div>
        <div class="help-row"><span class="help-key">B</span><span class="help-desc">Toggle belt cloud</span></div>
        <div class="help-row"><span class="help-key">1-6</span><span class="help-desc">Focus camera on satellite</span></div>
        <div class="help-row"><span class="help-key">H</span><span class="help-desc">Toggle this help</span></div>
    </div>

    <!-- Scripts (reuse same physics modules) -->
    <script src="cesium_config.js"></script>
    <script src="js/van_allen_model.js?v=2"></script>
    <script src="js/starfish_prime.js?v=2"></script>

    <script>
    (function() {
        'use strict';

        // --- Constants ---
        var R_E = VanAllenModel.R_EARTH;
        var DEG = VanAllenModel.DEG;
        var RAD = VanAllenModel.RAD;

        // --- Cesium Viewer ---
        var viewer = new Cesium.Viewer('cesiumContainer', {
            animation: false,
            timeline: false,
            fullscreenButton: false,
            vrButton: false,
            geocoder: false,
            homeButton: false,
            navigationHelpButton: false,
            sceneModePicker: false,
            baseLayerPicker: true,
            infoBox: false,
            selectionIndicator: false
        });

        viewer.scene.globe.enableLighting = false;
        viewer.scene.backgroundColor = Cesium.Color.BLACK;
        viewer.scene.screenSpaceCameraController.minimumZoomDistance = R_E * 0.1;
        viewer.scene.screenSpaceCameraController.maximumZoomDistance = R_E * 20;

        viewer.camera.setView({
            destination: new Cesium.Cartesian3(0, -R_E * 6, R_E * 4),
            orientation: {
                direction: new Cesium.Cartesian3(0, 0.83, -0.55),
                up: new Cesium.Cartesian3(0, 0.55, 0.83)
            }
        });

        // --- Satellite Definitions ---
        var COLORS = {
            CYAN:    { css: '#00ffff', cesium: Cesium.Color.CYAN },
            GREEN:   { css: '#00ff88', cesium: Cesium.Color.LIME },
            YELLOW:  { css: '#ffff00', cesium: Cesium.Color.YELLOW },
            ORANGE:  { css: '#ff8800', cesium: Cesium.Color.ORANGE },
            MAGENTA: { css: '#ff44ff', cesium: Cesium.Color.MAGENTA },
            WHITE:   { css: '#ffffff', cesium: Cesium.Color.WHITE }
        };

        var r_leo = R_E + 500e3;
        var r_meo = R_E + 20200e3;
        var r_geo = R_E + 35786e3;
        var a_leoMeo = (r_leo + r_meo) / 2;
        var e_leoMeo = (r_meo - r_leo) / (r_meo + r_leo);
        var a_gto = (r_leo + r_geo) / 2;
        var e_gto = (r_geo - r_leo) / (r_geo + r_leo);
        var a_meoGeo = (r_meo + r_geo) / 2;
        var e_meoGeo = (r_geo - r_meo) / (r_geo + r_meo);

        var SAT_DEFS = [
            { name: 'LEO-1',        color: COLORS.CYAN,    a: r_leo,    e: 0.001,    i: 51.6, raan: 0,   argp: 0,   M0: 0   },
            { name: 'MEO-GPS',      color: COLORS.GREEN,   a: r_meo,    e: 0.001,    i: 55.0, raan: 60,  argp: 0,   M0: 45  },
            { name: 'MEO-Transfer', color: COLORS.YELLOW,  a: a_leoMeo, e: e_leoMeo, i: 51.6, raan: 30,  argp: 0,   M0: 0   },
            { name: 'GTO',          color: COLORS.ORANGE,  a: a_gto,    e: e_gto,    i: 28.5, raan: 90,  argp: 180, M0: 0   },
            { name: 'MGTO',         color: COLORS.MAGENTA, a: a_meoGeo, e: e_meoGeo, i: 28.5, raan: 120, argp: 180, M0: 90  },
            { name: 'GEO-1',        color: COLORS.WHITE,   a: r_geo,    e: 0.001,    i: 0.1,  raan: 0,   argp: 0,   M0: 120 }
        ];

        // --- Simulation State ---
        var simTime = 0;
        var paused = true;
        var warpLevels = [1, 10, 60, 3600, 86400, 604800];
        var warpIndex = 0;
        var lastWallTime = performance.now();
        var frameCount = 0;

        var satellites = [];
        for (var si = 0; si < SAT_DEFS.length; si++) {
            var def = SAT_DEFS[si];
            satellites.push({
                name: def.name,
                color: def.color,
                orbit: VanAllenModel.createOrbit(def.a, def.e, def.i, def.raan, def.argp, def.M0),
                pos: [0, 0, 0],
                vel: [0, 0, 0],
                geo: { lat: 0, lon: 0, alt: 0 },
                flux: { proton10: 0, proton100: 0, electron05: 0, electron1: 0, L: 1, B: 0, B_B0: 1, doseRate: 0 },
                totalDose: 0,
                entity: null,
                orbitEntity: null
            });
        }

        // --- Create Cesium Entities ---
        for (var i = 0; i < satellites.length; i++) {
            (function(idx) {
                var sat = satellites[idx];
                var state = VanAllenModel.propagateOrbit(sat.orbit, 0);
                sat.pos = state.pos;
                sat.vel = state.vel;

                sat.entity = viewer.entities.add({
                    name: sat.name,
                    position: new Cesium.CallbackProperty(function() {
                        var ecef = VanAllenModel.eciToECEF(satellites[idx].pos, simTime);
                        return new Cesium.Cartesian3(ecef[0], ecef[1], ecef[2]);
                    }, false),
                    point: {
                        pixelSize: 10,
                        color: sat.color.cesium,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    },
                    label: {
                        text: new Cesium.CallbackProperty(function() {
                            var s = satellites[idx];
                            var fluxStr = s.flux.electron05 > 1 ? s.flux.electron05.toExponential(1) : '0';
                            return s.name + '\nL=' + s.flux.L.toFixed(2) + ' e-:' + fluxStr;
                        }, false),
                        font: '11px Courier New',
                        fillColor: sat.color.cesium,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(12, -8),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        scale: 0.9
                    }
                });
            })(i);
        }

        // Orbit polylines
        function buildOrbitPolylines() {
            for (var i = 0; i < satellites.length; i++) {
                if (satellites[i].orbitEntity) {
                    viewer.entities.remove(satellites[i].orbitEntity);
                }
                var path = VanAllenModel.getOrbitPath(satellites[i].orbit, 360);
                var positions = [];
                for (var p = 0; p < path.length; p++) {
                    var ecef = VanAllenModel.eciToECEF(path[p], simTime);
                    positions.push(new Cesium.Cartesian3(ecef[0], ecef[1], ecef[2]));
                }
                if (positions.length > 0) positions.push(positions[0]);
                satellites[i].orbitEntity = viewer.entities.add({
                    polyline: {
                        positions: positions,
                        width: 1.5,
                        material: satellites[i].color.cesium.withAlpha(0.4),
                        arcType: Cesium.ArcType.NONE
                    }
                });
            }
        }
        buildOrbitPolylines();

        // --- Field Lines ---
        var fieldLineEntities = [];
        var fieldLinesVisible = true;
        var FIELD_L_VALUES = [1.5, 2.0, 3.0, 4.0, 5.0, 6.5];
        var FIELD_NUM_LONS = 12;

        function buildFieldLines() {
            for (var fl = 0; fl < fieldLineEntities.length; fl++) {
                viewer.entities.remove(fieldLineEntities[fl]);
            }
            fieldLineEntities = [];
            if (!fieldLinesVisible) return;

            var lines = VanAllenModel.generateFieldLines(FIELD_L_VALUES, FIELD_NUM_LONS, simTime);
            for (var li = 0; li < lines.length; li++) {
                var line = lines[li];
                var positions = [];
                var hasNaN = false;
                for (var p = 0; p < line.positions.length; p++) {
                    var pos = line.positions[p];
                    if (isNaN(pos[0]) || isNaN(pos[1]) || isNaN(pos[2])) { hasNaN = true; break; }
                    positions.push(new Cesium.Cartesian3(pos[0], pos[1], pos[2]));
                }
                if (hasNaN || positions.length < 3) continue;

                var flux = VanAllenModel.getFluxAtLB(line.L, 1.0);
                var logFlux = Math.log10(Math.max(1, flux.total));
                var t = Math.min(1, logFlux / 7);
                var r = t;
                var g = Math.max(0, 1 - 2 * Math.abs(t - 0.5));
                var b = 1 - t;
                var alpha = 0.15 + 0.2 * t;

                fieldLineEntities.push(viewer.entities.add({
                    polyline: {
                        positions: positions,
                        width: 1.0,
                        material: new Cesium.Color(r, g, b, alpha),
                        arcType: Cesium.ArcType.NONE
                    }
                }));
            }
        }
        buildFieldLines();

        // --- Belt Point Cloud ---
        var beltPoints = null;
        var beltCloudVisible = true;
        var BELT_NUM_POINTS = 5000;
        var beltPointData = [];

        function initBeltCloud() {
            beltPointData = [];
            for (var bp = 0; bp < BELT_NUM_POINTS; bp++) {
                var L = 1.1 + Math.random() * 5.9;
                var magLat = (Math.random() - 0.5) * 2 * 60 * DEG;
                var cosLat = Math.cos(magLat);
                var r = L * R_E * cosLat * cosLat;
                var lon = Math.random() * 2 * Math.PI;
                if (r < R_E * 1.05) continue;
                beltPointData.push({ L: L, magLat: magLat, lon: lon, r: r });
            }

            if (beltPoints) viewer.scene.primitives.remove(beltPoints);
            beltPoints = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection());

            for (var k = 0; k < beltPointData.length; k++) {
                beltPoints.add({
                    position: Cesium.Cartesian3.ZERO,
                    pixelSize: 2,
                    color: Cesium.Color.BLUE
                });
            }
        }

        function updateBeltCloud() {
            if (!beltPoints || !beltCloudVisible) return;
            var gmst = VanAllenModel.OMEGA_EARTH * simTime;
            var cosG = Math.cos(gmst);
            var sinG = Math.sin(gmst);

            for (var k = 0; k < beltPointData.length; k++) {
                var pd = beltPointData[k];
                var pt = beltPoints.get(k);
                var r = pd.r;
                var cosLat = Math.cos(pd.magLat);
                var sinLat = Math.sin(pd.magLat);
                var cosLon = Math.cos(pd.lon);
                var sinLon = Math.sin(pd.lon);
                var xe = r * cosLat * cosLon;
                var ye = r * cosLat * sinLon;
                var ze = r * sinLat;
                pt.position = new Cesium.Cartesian3(xe * cosG - ye * sinG, xe * sinG + ye * cosG, ze);

                var flux = VanAllenModel.getFluxAtLB(pd.L, 1.0);
                var totalFlux = flux.total;
                if (StarfishPrime.isActive()) {
                    var tSince = StarfishPrime.getTimeSinceDetonation(simTime);
                    var enhancement = StarfishPrime.getInjectedFlux(pd.L, tSince);
                    totalFlux += enhancement.electron05_enhancement;
                }
                var logF = Math.log10(Math.max(1, totalFlux));
                var t = Math.min(1, logF / 7);
                pt.color = new Cesium.Color(t, Math.max(0, 1 - 2 * Math.abs(t - 0.5)), 1 - t, 0.15 + 0.6 * t);
            }
        }
        initBeltCloud();

        // --- Detonation Visual ---
        var detonationEntity = null;
        var flashEntity = null;
        // Marker showing where the detonation will occur (before triggering)
        var previewEntity = null;

        function updatePreviewMarker() {
            var alt = parseFloat(inputAlt.value) * 1000;
            var lat = parseFloat(inputLat.value);
            var lon = parseFloat(inputLon.value);
            if (isNaN(alt) || isNaN(lat) || isNaN(lon)) return;

            var pos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);

            if (!previewEntity) {
                previewEntity = viewer.entities.add({
                    position: pos,
                    point: {
                        pixelSize: 12,
                        color: Cesium.Color.RED.withAlpha(0.6),
                        outlineColor: Cesium.Color.YELLOW,
                        outlineWidth: 2,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    },
                    label: {
                        text: 'DETONATION POINT',
                        font: '10px Courier New',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(14, -5),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        scale: 0.85
                    }
                });
            } else {
                previewEntity.position = pos;
            }
        }

        function showDetonation(alt, lat, lon) {
            var pos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);

            // Remove preview
            if (previewEntity) {
                viewer.entities.remove(previewEntity);
                previewEntity = null;
            }

            flashEntity = viewer.entities.add({
                position: pos,
                point: {
                    pixelSize: 80,
                    color: Cesium.Color.WHITE.withAlpha(1.0),
                    outlineColor: Cesium.Color.ORANGERED,
                    outlineWidth: 4,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });

            detonationEntity = viewer.entities.add({
                position: pos,
                ellipsoid: {
                    radii: new Cesium.CallbackProperty(function() {
                        if (!StarfishPrime.isActive()) return new Cesium.Cartesian3(1, 1, 1);
                        var t = StarfishPrime.getTimeSinceDetonation(simTime);
                        var radius = Math.min(500000, 10000 + t * 50000);
                        return new Cesium.Cartesian3(radius, radius, radius);
                    }, false),
                    material: new Cesium.ColorMaterialProperty(
                        new Cesium.CallbackProperty(function() {
                            if (!StarfishPrime.isActive()) return Cesium.Color.TRANSPARENT;
                            var t = StarfishPrime.getTimeSinceDetonation(simTime);
                            var alpha = Math.max(0, 1 - t / 20);
                            return new Cesium.Color(1, 0.3, 0.1, alpha * 0.4);
                        }, false)
                    )
                }
            });
        }

        // --- Cross-Section Canvas ---
        var csCanvas = document.getElementById('crossSection');
        var csCtx = csCanvas.getContext('2d');
        var CS_W = 200;
        var CS_H = 150;
        var csImageData = csCtx.createImageData(CS_W, CS_H);

        function drawCrossSection() {
            var data = csImageData.data;
            var rMin = 1.0, rMax = 8.0;
            var latMin = -75 * DEG, latMax = 75 * DEG;

            for (var py = 0; py < CS_H; py++) {
                var magLat = latMax - (latMax - latMin) * py / (CS_H - 1);
                var magColat = Math.PI / 2 - magLat;
                var sinColat = Math.sin(magColat);
                var sin2 = sinColat * sinColat;
                var cosColat = Math.cos(magColat);

                for (var px = 0; px < CS_W; px++) {
                    var rRe = rMin + (rMax - rMin) * px / (CS_W - 1);
                    var idx = (py * CS_W + px) * 4;

                    if (rRe < 1.0) {
                        data[idx] = 15; data[idx + 1] = 20; data[idx + 2] = 30; data[idx + 3] = 255;
                        continue;
                    }

                    var L = (sin2 > 0.01) ? rRe / sin2 : 1000;
                    var B_rel = Math.sqrt(1 + 3 * cosColat * cosColat) / (sinColat * sinColat * sinColat);
                    var B_B0 = Math.max(1, B_rel);
                    var flux = VanAllenModel.getFluxAtLB(L, B_B0);
                    var totalFlux = flux.total;

                    if (StarfishPrime.isActive()) {
                        var tSince = StarfishPrime.getTimeSinceDetonation(simTime);
                        var enh = StarfishPrime.getInjectedFlux(L, tSince);
                        totalFlux += enh.electron05_enhancement;
                    }

                    var logF = Math.log10(Math.max(1, totalFlux));
                    var t = Math.min(1, logF / 7);
                    var cr, cg, cb;
                    if (t < 0.25) { cr = 0; cg = 0; cb = Math.floor(40 + 180 * (t / 0.25)); }
                    else if (t < 0.5) { var tt = (t - 0.25) / 0.25; cr = 0; cg = Math.floor(200 * tt); cb = Math.floor(220 * (1 - tt)); }
                    else if (t < 0.75) { var tt2 = (t - 0.5) / 0.25; cr = Math.floor(255 * tt2); cg = 200; cb = 0; }
                    else { var tt3 = (t - 0.75) / 0.25; cr = 255; cg = Math.floor(200 * (1 - tt3)); cb = 0; }

                    data[idx] = cr; data[idx + 1] = cg; data[idx + 2] = cb; data[idx + 3] = 255;
                }
            }

            var tempCanvas = document.createElement('canvas');
            tempCanvas.width = CS_W; tempCanvas.height = CS_H;
            tempCanvas.getContext('2d').putImageData(csImageData, 0, 0);
            csCtx.imageSmoothingEnabled = false;
            csCtx.drawImage(tempCanvas, 0, 0, 400, 300);

            // Axes and labels
            csCtx.strokeStyle = '#335577'; csCtx.lineWidth = 0.5;
            csCtx.font = '10px Courier New'; csCtx.fillStyle = '#446688';
            for (var rr = 1; rr <= 8; rr++) {
                var xp = ((rr - rMin) / (rMax - rMin)) * 400;
                csCtx.beginPath(); csCtx.moveTo(xp, 0); csCtx.lineTo(xp, 300); csCtx.stroke();
                csCtx.fillText(rr + 'Re', xp + 2, 295);
            }
            var yEq = 150;
            csCtx.strokeStyle = '#556677'; csCtx.setLineDash([4, 4]);
            csCtx.beginPath(); csCtx.moveTo(0, yEq); csCtx.lineTo(400, yEq); csCtx.stroke();
            csCtx.setLineDash([]); csCtx.fillText('0\u00B0', 2, yEq - 3);

            // L-shell curves
            csCtx.strokeStyle = '#445566'; csCtx.lineWidth = 0.7; csCtx.setLineDash([3, 3]);
            var Ls = [1.5, 2, 3, 4, 5, 6];
            for (var lsi = 0; lsi < Ls.length; lsi++) {
                var Lv = Ls[lsi];
                csCtx.beginPath();
                var started = false;
                for (var yy = 0; yy < CS_H; yy++) {
                    var mLat = latMax - (latMax - latMin) * yy / (CS_H - 1);
                    var cosL = Math.cos(mLat);
                    var rL = Lv * cosL * cosL;
                    if (rL < rMin || rL > rMax) { started = false; continue; }
                    var xPlot = ((rL - rMin) / (rMax - rMin)) * 400;
                    var yPlot = (yy / CS_H) * 300;
                    if (!started) { csCtx.moveTo(xPlot, yPlot); started = true; }
                    else csCtx.lineTo(xPlot, yPlot);
                }
                csCtx.stroke();
                var rEq = Lv;
                if (rEq >= rMin && rEq <= rMax) {
                    csCtx.fillStyle = '#667788';
                    csCtx.fillText('L=' + Lv, ((rEq - rMin) / (rMax - rMin)) * 400 + 2, yEq + 12);
                }
            }
            csCtx.setLineDash([]);

            // Injection L marker (if detonated)
            if (StarfishPrime.isActive()) {
                var dp = StarfishPrime.getDetonationParams();
                var injL = dp.injectionL;
                if (injL >= rMin && injL <= rMax) {
                    var xInj = ((injL - rMin) / (rMax - rMin)) * 400;
                    csCtx.strokeStyle = '#ff4422';
                    csCtx.lineWidth = 1.5;
                    csCtx.setLineDash([6, 3]);
                    csCtx.beginPath(); csCtx.moveTo(xInj, 0); csCtx.lineTo(xInj, 300); csCtx.stroke();
                    csCtx.setLineDash([]);
                    csCtx.fillStyle = '#ff6644';
                    csCtx.fillText('INJ L=' + injL.toFixed(2), xInj + 3, 12);
                }
            }

            // Satellite positions
            for (var si2 = 0; si2 < satellites.length; si2++) {
                var sat = satellites[si2];
                var rPlotRe = (R_E + sat.geo.alt) / R_E;
                if (rPlotRe < rMin || rPlotRe > rMax) continue;
                var satMagLat = Math.PI / 2 - VanAllenModel.geoToGeomagnetic(sat.geo.lat, sat.geo.lon).magColat;
                if (Math.abs(satMagLat) > 75 * DEG) continue;
                var xSat = ((rPlotRe - rMin) / (rMax - rMin)) * 400;
                var ySat = ((latMax - satMagLat) / (latMax - latMin)) * 300;
                csCtx.fillStyle = sat.color.css;
                csCtx.beginPath(); csCtx.arc(xSat, ySat, 4, 0, 2 * Math.PI); csCtx.fill();
                csCtx.fillText(sat.name, xSat + 6, ySat + 3);
            }
        }

        // --- Telemetry Panel ---
        var telemetryDiv = document.getElementById('telemetryContent');

        function buildTelemetryHTML() {
            var html = '';
            for (var i = 0; i < satellites.length; i++) {
                var sat = satellites[i];
                var f = sat.flux;
                var altKm = sat.geo.alt / 1000;
                var doseClass = (f.doseRate > 0.01) ? 'alert' : (f.doseRate > 0.001) ? 'warn' : '';
                var doseStr = (f.doseRate > 0.001) ?
                    (f.doseRate * 1000).toFixed(2) + ' mrad/s' :
                    (f.doseRate * 1e6).toFixed(1) + ' urad/s';
                var logDose = Math.log10(Math.max(1e-9, f.doseRate));
                var barPct = Math.min(100, Math.max(0, ((logDose + 9) / 9) * 100));
                var barColor = (barPct > 70) ? '#ff4422' : (barPct > 40) ? '#ffaa22' : '#2288ff';

                html += '<div class="sat-block">';
                html += '<div class="sat-name" style="color:' + sat.color.css + '">' + sat.name + '</div>';
                html += '<div class="data-row"><span class="data-label">Alt</span><span class="data-value">' + altKm.toFixed(0) + ' km</span></div>';
                html += '<div class="data-row"><span class="data-label">L</span><span class="data-value">' + f.L.toFixed(2) + '</span></div>';
                html += '<div class="data-row"><span class="data-label">|B|</span><span class="data-value">' + f.B.toExponential(1) + ' T</span></div>';
                html += '<div class="data-row"><span class="data-label">p+ >10</span><span class="data-value">' + f.proton10.toExponential(1) + '</span></div>';
                html += '<div class="data-row"><span class="data-label">e- >0.5</span><span class="data-value">' + f.electron05.toExponential(1) + '</span></div>';
                html += '<div class="data-row"><span class="data-label">Dose</span><span class="data-value ' + doseClass + '">' + doseStr + '</span></div>';
                html += '<div class="data-row"><span class="data-label">TID</span><span class="data-value">' + formatDose(sat.totalDose) + '</span></div>';
                html += '<div class="dose-bar"><div class="dose-bar-fill" style="width:' + barPct.toFixed(0) + '%;background:' + barColor + ';"></div></div>';
                html += '</div>';
            }
            telemetryDiv.innerHTML = html;
        }

        function formatDose(dose) {
            if (dose > 1000) return (dose / 1000).toFixed(1) + ' krad';
            if (dose > 1) return dose.toFixed(1) + ' rad';
            if (dose > 0.001) return (dose * 1000).toFixed(1) + ' mrad';
            return (dose * 1e6).toFixed(0) + ' urad';
        }

        // --- Event Log ---
        var logDiv = document.getElementById('eventLogContent');
        var logEntries = [];

        function addLogEntry(msg, cssClass) {
            var timeStr = formatSimTime(simTime);
            cssClass = cssClass || '';
            logEntries.push({ time: timeStr, msg: msg, css: cssClass });
            if (logEntries.length > 100) logEntries.shift();
            var html = '';
            for (var le = logEntries.length - 1; le >= Math.max(0, logEntries.length - 50); le--) {
                var e = logEntries[le];
                html += '<div class="log-entry"><span class="log-time">' + e.time + '</span> <span class="log-msg ' + e.css + '">' + e.msg + '</span></div>';
            }
            logDiv.innerHTML = html;
        }

        function formatSimTime(t) {
            var days = Math.floor(t / 86400);
            var rem = t - days * 86400;
            var hrs = Math.floor(rem / 3600);
            rem -= hrs * 3600;
            var mins = Math.floor(rem / 60);
            var secs = Math.floor(rem - mins * 60);
            return days + 'd ' + pad2(hrs) + ':' + pad2(mins) + ':' + pad2(secs);
        }
        function pad2(n) { return n < 10 ? '0' + n : '' + n; }

        addLogEntry('Configurable nuclear detonation sim initialized.');
        addLogEntry('Set parameters and press DETONATE (or D key).');

        // --- Alert Thresholds ---
        var lastAlertTime = {};
        var ALERT_DOSE_RATE = 0.005;
        var ALERT_COOLDOWN = 600;

        function checkAlerts() {
            for (var i = 0; i < satellites.length; i++) {
                var sat = satellites[i];
                if (sat.flux.doseRate > ALERT_DOSE_RATE) {
                    var lastAlert = lastAlertTime[sat.name] || -99999;
                    if (simTime - lastAlert > ALERT_COOLDOWN) {
                        lastAlertTime[sat.name] = simTime;
                        addLogEntry(sat.name + ': HIGH DOSE RATE ' + (sat.flux.doseRate * 1000).toFixed(1) + ' mrad/s (L=' + sat.flux.L.toFixed(2) + ')', 'alert');
                    }
                }
            }
        }

        // --- Status Bar ---
        var statusBar = document.getElementById('statusBar');
        function updateStatusBar() {
            var text = 'NUCLEAR DETONATION SIM';
            if (StarfishPrime.isActive()) {
                var dp = StarfishPrime.getDetonationParams();
                text += '  |  DETONATED (' + (dp.altitude / 1000).toFixed(0) + ' km, L=' + dp.injectionL.toFixed(2) + ')';
            }
            text += paused ? '  [PAUSED]' : '  [' + warpLevels[warpIndex] + 'x]';
            statusBar.textContent = text;
            statusBar.style.borderColor = StarfishPrime.isActive() ? '#aa3020' : '#1a3a6a';
            statusBar.style.color = StarfishPrime.isActive() ? '#ff8866' : '#88ccff';
        }

        // --- Detonation Config UI ---
        var inputAlt = document.getElementById('inputAlt');
        var sliderAlt = document.getElementById('sliderAlt');
        var inputLat = document.getElementById('inputLat');
        var inputLon = document.getElementById('inputLon');
        var inputYield = document.getElementById('inputYield');
        var presetSelect = document.getElementById('presetSelect');
        var paramL = document.getElementById('paramL');
        var paramSigma = document.getElementById('paramSigma');
        var paramFlux = document.getElementById('paramFlux');
        var paramTrap = document.getElementById('paramTrap');
        var paramRegime = document.getElementById('paramRegime');

        // Presets
        var PRESETS = {
            starfish:      { alt: 2000,  lat: 16.7,  lon: -169.5, yield: '1400000' },
            starfish_hist: { alt: 400,   lat: 16.7,  lon: -169.5, yield: '1400000' },
            low_leo:       { alt: 300,   lat: 16.7,  lon: -169.5, yield: '1400000' },
            inner_belt:    { alt: 1500,  lat: 16.7,  lon: -169.5, yield: '1400000' },
            slot:          { alt: 8000,  lat: 0,     lon: -169.5, yield: '1400000' },
            outer_belt:    { alt: 20000, lat: 0,     lon: -169.5, yield: '1400000' },
            geo:           { alt: 35000, lat: 0,     lon: -169.5, yield: '1400000' },
            polar:         { alt: 1000,  lat: 80,    lon: 0,      yield: '1400000' },
            equatorial:    { alt: 2000,  lat: 0,     lon: -169.5, yield: '1400000' }
        };

        presetSelect.addEventListener('change', function() {
            var p = PRESETS[presetSelect.value];
            if (!p) return;
            inputAlt.value = p.alt;
            sliderAlt.value = p.alt;
            inputLat.value = p.lat;
            inputLon.value = p.lon;
            inputYield.value = p.yield;
            updateComputedParams();
            updatePreviewMarker();
        });

        // Sync slider ↔ number input
        inputAlt.addEventListener('input', function() {
            sliderAlt.value = inputAlt.value;
            presetSelect.value = 'custom';
            updateComputedParams();
            updatePreviewMarker();
        });
        sliderAlt.addEventListener('input', function() {
            inputAlt.value = sliderAlt.value;
            presetSelect.value = 'custom';
            updateComputedParams();
            updatePreviewMarker();
        });
        inputLat.addEventListener('input', function() {
            presetSelect.value = 'custom';
            updateComputedParams();
            updatePreviewMarker();
        });
        inputLon.addEventListener('input', function() {
            presetSelect.value = 'custom';
            updateComputedParams();
            updatePreviewMarker();
        });
        inputYield.addEventListener('change', function() {
            presetSelect.value = 'custom';
            updateComputedParams();
        });

        function updateComputedParams() {
            var altM = parseFloat(inputAlt.value) * 1000;
            var lat = parseFloat(inputLat.value);
            var lon = parseFloat(inputLon.value);
            var yld = parseFloat(inputYield.value);
            if (isNaN(altM) || isNaN(lat) || isNaN(lon) || isNaN(yld)) return;

            var params = StarfishPrime.computeInjectionParams(altM, lat, lon, yld);

            paramL.textContent = params.L.toFixed(3);
            paramSigma.textContent = params.sigma.toFixed(3);
            paramFlux.textContent = params.peakFlux.toExponential(2) + ' /cm\u00B2/s';
            paramTrap.textContent = (params.trappingFraction * 100).toFixed(1) + '%';

            // Color coding
            paramTrap.className = 'param-value';
            if (params.trappingFraction > 0.8) paramTrap.classList.add('good');
            else if (params.trappingFraction < 0.3) paramTrap.classList.add('warn');

            // Regime label
            var L = params.L;
            var regime;
            if (L < 1.5) regime = 'INNER BELT';
            else if (L < 2.5) regime = 'SLOT REGION';
            else if (L < 6) regime = 'OUTER BELT';
            else if (L < 8) regime = 'MAGNETOPAUSE';
            else regime = 'BEYOND TRAPPING';

            if (params.trappingFraction < 0.1) regime = 'MINIMAL TRAPPING';
            paramRegime.textContent = regime;
            paramRegime.className = 'param-value';
            if (regime === 'MINIMAL TRAPPING' || regime === 'BEYOND TRAPPING') paramRegime.classList.add('warn');
            else paramRegime.classList.add('good');
        }
        updateComputedParams();
        updatePreviewMarker();

        // --- UI Controls ---
        var btnPause = document.getElementById('btnPause');
        var btnReset = document.getElementById('btnReset');
        var btnWarpDn = document.getElementById('btnWarpDn');
        var btnWarpUp = document.getElementById('btnWarpUp');
        var btnDetonate = document.getElementById('btnDetonate');
        var warpDisplay = document.getElementById('warpDisplay');
        var simTimeDisplay = document.getElementById('simTimeDisplay');
        var detonationTimeRow = document.getElementById('detonationTimeRow');
        var detonationTimeDisplay = document.getElementById('detonationTimeDisplay');
        var chkFieldLines = document.getElementById('chkFieldLines');
        var chkBeltCloud = document.getElementById('chkBeltCloud');

        btnPause.addEventListener('click', function() { togglePause(); });
        btnReset.addEventListener('click', function() { resetSim(); });
        btnWarpDn.addEventListener('click', function() { changeWarp(-1); });
        btnWarpUp.addEventListener('click', function() { changeWarp(1); });
        btnDetonate.addEventListener('click', function() { triggerDetonation(); });
        chkFieldLines.addEventListener('change', function() { toggleFieldLines(); });
        chkBeltCloud.addEventListener('change', function() { toggleBeltCloud(); });

        function togglePause() {
            paused = !paused;
            btnPause.textContent = paused ? '\u25B6 Play' : '\u23F8 Pause';
            lastWallTime = performance.now();
            updateStatusBar();
        }

        function changeWarp(dir) {
            warpIndex = Math.max(0, Math.min(warpLevels.length - 1, warpIndex + dir));
            warpDisplay.textContent = warpLevels[warpIndex] + 'x';
            updateStatusBar();
        }

        function triggerDetonation() {
            if (StarfishPrime.isActive()) return;

            var altM = parseFloat(inputAlt.value) * 1000;
            var lat = parseFloat(inputLat.value);
            var lon = parseFloat(inputLon.value);
            var yld = parseFloat(inputYield.value);
            if (isNaN(altM) || isNaN(lat) || isNaN(lon)) return;

            StarfishPrime.detonate(simTime, {
                altitude: altM,
                lat: lat,
                lon: lon,
                yield: yld
            });

            var dp = StarfishPrime.getDetonationParams();
            btnDetonate.classList.add('active');
            detonationTimeRow.style.display = 'flex';
            showDetonation(altM, lat, lon);

            var altStr = (altM / 1000).toFixed(0);
            var yieldStr = yld >= 1e6 ? (yld / 1e6).toFixed(1) + ' MT' : (yld / 1000).toFixed(0) + ' kT';
            addLogEntry('DETONATION: ' + altStr + ' km, ' + lat.toFixed(1) + '\u00B0N ' + Math.abs(lon).toFixed(1) + '\u00B0' + (lon < 0 ? 'W' : 'E') + ', ' + yieldStr, 'starfish');
            addLogEntry('Injection L=' + dp.injectionL.toFixed(2) + ', \u03C3=' + dp.sigma.toFixed(2) + ', trap=' + (dp.trappingFraction * 100).toFixed(0) + '%', 'starfish');

            if (dp.trappingFraction < 0.3) {
                addLogEntry('WARNING: Low trapping fraction — most particles lost before completing drift orbit', 'alert');
            }
            if (dp.injectionL > 7) {
                addLogEntry('WARNING: Near magnetopause — open drift shells, limited trapping', 'alert');
            }

            // Disable config inputs
            inputAlt.disabled = true;
            sliderAlt.disabled = true;
            inputLat.disabled = true;
            inputLon.disabled = true;
            inputYield.disabled = true;
            presetSelect.disabled = true;

            updateStatusBar();
            setTimeout(function() { buildFieldLines(); }, 100);
        }

        function resetSim() {
            simTime = 0;
            paused = true;
            StarfishPrime.reset();
            btnDetonate.classList.remove('active');
            btnPause.textContent = '\u25B6 Play';
            detonationTimeRow.style.display = 'none';
            for (var i = 0; i < satellites.length; i++) {
                satellites[i].totalDose = 0;
            }
            lastAlertTime = {};
            logEntries = [];
            logDiv.innerHTML = '';
            addLogEntry('Simulation reset.');
            addLogEntry('Set parameters and press DETONATE (or D key).');

            if (detonationEntity) { viewer.entities.remove(detonationEntity); detonationEntity = null; }
            if (flashEntity) { viewer.entities.remove(flashEntity); flashEntity = null; }

            // Re-enable config inputs
            inputAlt.disabled = false;
            sliderAlt.disabled = false;
            inputLat.disabled = false;
            inputLon.disabled = false;
            inputYield.disabled = false;
            presetSelect.disabled = false;

            buildOrbitPolylines();
            buildFieldLines();
            updateComputedParams();
            updatePreviewMarker();
            updateStatusBar();
        }

        function toggleFieldLines() {
            fieldLinesVisible = chkFieldLines.checked;
            buildFieldLines();
        }

        function toggleBeltCloud() {
            beltCloudVisible = chkBeltCloud.checked;
            if (beltPoints) beltPoints.show = beltCloudVisible;
        }

        // --- Keyboard ---
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case '+': case '=':
                    changeWarp(1);
                    break;
                case '-': case '_':
                    changeWarp(-1);
                    break;
                case 'd': case 'D':
                    triggerDetonation();
                    break;
                case 'r': case 'R':
                    resetSim();
                    break;
                case 'f': case 'F':
                    chkFieldLines.checked = !chkFieldLines.checked;
                    toggleFieldLines();
                    break;
                case 'b': case 'B':
                    chkBeltCloud.checked = !chkBeltCloud.checked;
                    toggleBeltCloud();
                    break;
                case 'h': case 'H':
                    var help = document.getElementById('helpOverlay');
                    help.style.display = help.style.display === 'block' ? 'none' : 'block';
                    break;
                case '1': case '2': case '3': case '4': case '5': case '6':
                    var satIdx = parseInt(e.key) - 1;
                    if (satIdx >= 0 && satIdx < satellites.length) {
                        focusOnSatellite(satIdx);
                    }
                    break;
            }
        });

        function focusOnSatellite(idx) {
            var sat = satellites[idx];
            var ecef = VanAllenModel.eciToECEF(sat.pos, simTime);
            var target = new Cesium.Cartesian3(ecef[0], ecef[1], ecef[2]);
            var offset = new Cesium.HeadingPitchRange(0, -Math.PI / 4, sat.orbit.a * 0.5);
            viewer.camera.lookAt(target, offset);
            setTimeout(function() { viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY); }, 100);
            addLogEntry('Camera focused on ' + sat.name);
        }

        // --- Flash Decay ---
        function updateFlash() {
            if (!flashEntity || !StarfishPrime.isActive()) return;
            var t = StarfishPrime.getTimeSinceDetonation(simTime);
            var emp = StarfishPrime.getEMPIntensity(t);
            if (emp < 0.01) {
                if (flashEntity) { viewer.entities.remove(flashEntity); flashEntity = null; }
                return;
            }
            flashEntity.point.pixelSize = 20 + 60 * emp;
            flashEntity.point.color = Cesium.Color.WHITE.withAlpha(emp);
        }

        // --- Main Simulation Loop ---
        viewer.clock.onTick.addEventListener(function() {
            var now = performance.now();
            var wallDt = (now - lastWallTime) / 1000;
            lastWallTime = now;
            frameCount++;

            if (!paused) {
                var dt = wallDt * warpLevels[warpIndex];
                dt = Math.min(dt, 604800);
                simTime += dt;
                for (var si = 0; si < satellites.length; si++) {
                    satellites[si].totalDose += satellites[si].flux.doseRate * dt;
                }
            }

            for (var i = 0; i < satellites.length; i++) {
                var sat = satellites[i];
                var state = VanAllenModel.propagateOrbit(sat.orbit, simTime);
                sat.pos = state.pos;
                sat.vel = state.vel;
                sat.geo = VanAllenModel.eciToGeographic(sat.pos, simTime);
                var r = R_E + sat.geo.alt;
                sat.flux = VanAllenModel.getFlux(r, sat.geo.lat, sat.geo.lon, simTime);
                if (StarfishPrime.isActive()) {
                    var tSince = StarfishPrime.getTimeSinceDetonation(simTime);
                    var enh = StarfishPrime.getInjectedFlux(sat.flux.L, tSince);
                    sat.flux.electron05 += enh.electron05_enhancement;
                    sat.flux.electron1 += enh.electron1_enhancement;
                    sat.flux.doseRate = sat.flux.proton10 * 2.0e-9 + sat.flux.electron05 * 3.0e-10;
                }
            }

            if (frameCount % 30 === 0) buildTelemetryHTML();
            if (frameCount % 15 === 0) {
                simTimeDisplay.textContent = formatSimTime(simTime);
                if (StarfishPrime.isActive()) {
                    detonationTimeDisplay.textContent = formatSimTime(StarfishPrime.getTimeSinceDetonation(simTime));
                }
            }
            if (frameCount % 60 === 0) drawCrossSection();
            if (frameCount % 60 === 0 && beltCloudVisible) updateBeltCloud();
            if (frameCount % 120 === 0 && StarfishPrime.isActive()) buildFieldLines();
            if (frameCount % 60 === 0) checkAlerts();
            updateFlash();
        });

        // Initial draw
        updateStatusBar();
        drawCrossSection();
        buildTelemetryHTML();

    })();
    </script>
</body>
</html>
