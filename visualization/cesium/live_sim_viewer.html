<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sim - All Domain Sim</title>

    <!-- Cesium -->
    <link rel="stylesheet" href="lib/Cesium/Widgets/widgets.css">
    <script src="lib/Cesium/Cesium.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }

        #cesiumContainer {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
        }

        #hudCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .panel {
            position: absolute;
            background: rgba(10, 15, 10, 0.85);
            border: 1px solid #00aa00;
            border-radius: 4px;
            padding: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 20;
            pointer-events: auto;
        }

        #flightDataPanel { top: 70px; left: 10px; width: 200px; }
        #systemsPanel { top: 70px; right: 10px; width: 210px; }

        #orbitalPanel {
            top: 70px; right: 230px; width: 220px;
            border-color: #0088ff;
            display: none;
        }
        #orbitalPanel h3 { color: #44aaff; border-bottom-color: #003366; }
        #orbitalPanel .data-label { color: #0088cc; }
        #orbitalPanel .data-value { color: #44ccff; }

        #entityListPanel {
            bottom: 10px; right: 10px; width: 220px;
            max-height: 200px; overflow-y: auto;
        }

        #controlsHelp {
            bottom: 10px; left: 50%;
            transform: translateX(-50%);
            max-width: 800px;
            display: none;
        }

        #statusBar {
            top: 5px; left: 50%;
            transform: translateX(-50%);
            padding: 5px 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        #modeIndicator {
            position: absolute;
            top: 40px; left: 50%;
            transform: translateX(-50%);
            color: #44ccff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 20;
            pointer-events: none;
            display: none;
        }

        .panel h3 {
            color: #00ff88;
            font-size: 11px;
            margin-bottom: 6px;
            border-bottom: 1px solid #005500;
            padding-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            line-height: 1.4;
        }

        .data-label { color: #00aa00; }
        .data-value { color: #00ff00; text-align: right; }
        .data-value.warn { color: #ffff00; }
        .data-value.alert { color: #ff3333; }
        .data-value.blue { color: #44ccff; }

        .key-grid {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 2px 10px;
        }
        .key { color: #00ffff; font-weight: bold; }
        .key-desc { color: #00aa00; }

        .entity-row {
            margin: 2px 0;
            font-size: 11px;
            line-height: 1.4;
        }
        .entity-name { color: #00ff00; }
        .entity-type { color: #006600; font-size: 10px; }

        /* ===================== SPLASH SCREEN ===================== */
        #splashOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 15, 0.95);
            z-index: 300;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 60px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            overflow-y: auto;
        }

        #splashOverlay h1 {
            font-size: 42px;
            color: #44aaff;
            text-shadow: 0 0 30px rgba(68, 170, 255, 0.6);
            margin-bottom: 8px;
            letter-spacing: 4px;
        }

        #splashOverlay .splash-subtitle {
            color: #006600;
            font-size: 13px;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        #splashOverlay .splash-section-title {
            color: #00ff88;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
            border-bottom: 1px solid #003300;
            padding-bottom: 6px;
            width: 600px;
            max-width: 90vw;
        }

        #splashOverlay .splash-status {
            color: #00aa00;
            font-size: 13px;
            margin: 10px 0;
        }

        #splashOverlay .splash-error {
            color: #ff3333;
            font-size: 13px;
            margin-top: 8px;
        }

        .sim-card {
            width: 600px;
            max-width: 90vw;
            background: rgba(0, 30, 0, 0.6);
            border: 1px solid #004400;
            border-radius: 6px;
            padding: 14px 18px;
            margin: 6px 0;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }
        .sim-card:hover {
            border-color: #00ff00;
            background: rgba(0, 60, 0, 0.5);
        }
        .sim-card.selected {
            border-color: #44aaff;
            background: rgba(0, 40, 80, 0.5);
            box-shadow: 0 0 12px rgba(68, 170, 255, 0.3);
        }
        .sim-card-name {
            font-size: 16px;
            font-weight: bold;
            color: #44aaff;
            margin-bottom: 4px;
        }
        .sim-card-meta {
            font-size: 11px;
            color: #006600;
        }
        .sim-card-meta span { margin-right: 14px; }

        .entity-card {
            width: 600px;
            max-width: 90vw;
            background: rgba(0, 30, 0, 0.6);
            border: 1px solid #004400;
            border-radius: 6px;
            padding: 12px 18px;
            margin: 4px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.15s, background 0.15s;
        }
        .entity-card:hover {
            border-color: #00ff00;
            background: rgba(0, 60, 0, 0.5);
        }
        .entity-card.selected {
            border-color: #44aaff;
            background: rgba(0, 40, 80, 0.5);
            box-shadow: 0 0 12px rgba(68, 170, 255, 0.3);
        }
        .entity-card .team-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .entity-card-info { flex: 1; }
        .entity-card-name { font-size: 14px; font-weight: bold; color: #00ff00; }
        .entity-card-detail { font-size: 11px; color: #006600; margin-top: 2px; }
        .entity-card-physics {
            font-size: 10px; color: #44aaff;
            background: rgba(68, 170, 255, 0.15);
            padding: 2px 8px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .splash-btn {
            background: rgba(0, 100, 0, 0.5);
            border: 1px solid #00aa00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 20px 6px;
            letter-spacing: 1px;
            transition: background 0.15s, border-color 0.15s;
        }
        .splash-btn:hover {
            background: rgba(0, 160, 0, 0.5);
            border-color: #00ff00;
        }
        .splash-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .splash-btn.primary {
            background: rgba(0, 60, 120, 0.6);
            border-color: #44aaff;
            color: #44aaff;
            font-size: 16px;
            padding: 12px 40px;
        }
        .splash-btn.primary:hover {
            background: rgba(0, 80, 160, 0.6);
            border-color: #88ccff;
        }

        .splash-back-link {
            color: #005500;
            font-size: 11px;
            cursor: pointer;
            margin-top: 4px;
            margin-bottom: 10px;
        }
        .splash-back-link:hover { color: #00aa00; }

        .splash-empty {
            color: #444;
            font-size: 13px;
            margin: 20px 0;
            font-style: italic;
        }

        /* ===================== LOADING OVERLAY ===================== */
        #loadingOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 250;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        #loadingOverlay h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #44aaff;
            text-shadow: 0 0 20px rgba(68, 170, 255, 0.5);
        }

        #loadingStatus { color: #00aa00; font-size: 14px; }
        #loadingError { color: #ff3333; font-size: 14px; margin-top: 10px; display: none; }

        #msgOverlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* ===================== SETTINGS GEAR ===================== */
        #settingsBtn {
            position: absolute;
            top: 8px; left: 10px;
            width: 32px; height: 32px;
            background: rgba(10, 15, 10, 0.7);
            border: 1px solid #005500;
            border-radius: 4px;
            color: #00aa00;
            font-size: 20px;
            cursor: pointer;
            z-index: 30;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: border-color 0.15s;
        }
        #settingsBtn:hover { border-color: #00ff00; color: #00ff00; }
        #settingsBtn.open { border-color: #44aaff; color: #44aaff; }

        #settingsDropdown {
            position: absolute;
            top: 44px; left: 10px;
            background: rgba(10, 15, 10, 0.92);
            border: 1px solid #00aa00;
            border-radius: 4px;
            padding: 8px 0;
            z-index: 30;
            display: none;
            min-width: 190px;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #005500 transparent;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        #settingsDropdown.open { display: block; }

        .settings-item {
            display: flex;
            align-items: center;
            padding: 5px 14px;
            cursor: pointer;
            color: #00aa00;
            gap: 8px;
            transition: background 0.1s;
        }
        .settings-item:hover { background: rgba(0, 60, 0, 0.5); }
        .settings-item .settings-check {
            width: 14px; height: 14px;
            border: 1px solid #005500;
            border-radius: 2px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: #00ff00;
            flex-shrink: 0;
        }
        .settings-item.active .settings-check {
            border-color: #00ff00;
            background: rgba(0, 100, 0, 0.4);
        }
        .settings-item .settings-label { flex: 1; }
        .settings-item .settings-key {
            color: #006600; font-size: 10px;
        }
        .settings-sep {
            height: 1px;
            background: #003300;
            margin: 4px 10px;
        }
        .settings-section-title {
            padding: 3px 14px;
            color: #006600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .settings-row {
            display: flex;
            align-items: center;
            padding: 4px 14px;
            color: #00aa00;
            gap: 8px;
            font-size: 12px;
        }
        .settings-row .settings-label { flex: 1; }
        .settings-row select,
        .settings-row input[type="number"] {
            background: rgba(0, 30, 0, 0.8);
            border: 1px solid #005500;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 2px 4px;
            width: 60px;
            border-radius: 2px;
        }
        .settings-row select:focus,
        .settings-row input[type="number"]:focus {
            border-color: #00ff00;
            outline: none;
        }

        /* Engine Selection Panel */
        #enginePanel {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 15, 10, 0.92);
            border: 1px solid #00aa00;
            border-radius: 4px;
            padding: 8px 0;
            z-index: 25;
            display: none;
            min-width: 280px;
            max-width: 400px;
            max-height: 60vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            pointer-events: auto;
            scrollbar-width: thin;
            scrollbar-color: #005500 transparent;
        }
        #enginePanel.open { display: block; }
        .ep-title {
            padding: 2px 14px 6px;
            color: #00ff88;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #003300;
            margin-bottom: 4px;
        }
        .ep-title .ep-hint { color: #006600; }
        .ep-cat {
            padding: 3px 14px 1px;
            color: #006600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ep-item {
            display: flex;
            align-items: center;
            padding: 4px 14px;
            cursor: pointer;
            color: #00aa00;
            gap: 8px;
            transition: background 0.1s;
        }
        .ep-item:hover { background: rgba(0, 60, 0, 0.5); }
        .ep-item.active {
            color: #00ff00;
            background: rgba(0, 80, 0, 0.4);
            border-left: 2px solid #00ff00;
        }
        .ep-key {
            width: 16px;
            color: #00ffff;
            font-size: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        .ep-name { flex: 1; font-weight: bold; }
        .ep-thrust {
            color: #006600;
            font-size: 10px;
            width: 60px;
            text-align: right;
        }
        .ep-desc {
            color: #004400;
            font-size: 9px;
            width: 80px;
            text-align: right;
        }

        /* Pointing Panel */
        #pointingPanel {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(10, 15, 10, 0.92);
            border: 1px solid #0088aa;
            border-radius: 4px;
            padding: 8px 0;
            z-index: 25;
            display: none;
            min-width: 200px;
            max-width: 280px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            pointer-events: auto;
        }
        #pointingPanel.open { display: block; }
        .pp-item {
            display: flex;
            align-items: center;
            padding: 5px 14px;
            cursor: pointer;
            color: #00aacc;
            gap: 8px;
            transition: background 0.1s;
        }
        .pp-item:hover { background: rgba(0, 40, 60, 0.5); }
        .pp-item.active {
            color: #00ffff;
            background: rgba(0, 60, 80, 0.4);
            border-left: 2px solid #00ffff;
        }
        .pp-label { flex: 1; font-weight: bold; font-size: 11px; }
        .pp-desc { color: #006688; font-size: 9px; }

        /* Maneuver Dialog */
        #maneuverDialog {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background: rgba(10, 15, 10, 0.95);
            border: 1px solid #00aa00;
            border-radius: 6px;
            padding: 0;
            min-width: 320px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
        }
        #maneuverDialog.open { display: block; }
        .mnv-header {
            padding: 10px 16px 6px;
            border-bottom: 1px solid #005500;
            text-align: center;
        }
        .mnv-header h3 { margin: 0 0 4px; font-size: 14px; letter-spacing: 2px; }
        .mnv-header .mnv-time { font-size: 11px; color: #00aa00; }
        .mnv-body { padding: 12px 16px; }
        .mnv-input-row {
            display: flex; align-items: center;
            margin-bottom: 8px; gap: 8px;
        }
        .mnv-input-row label {
            width: 80px; font-size: 12px; color: #00cc00;
            text-align: right;
        }
        .mnv-input-row input[type="number"] {
            flex: 1;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #005500;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 4px 6px;
            border-radius: 3px;
            width: 100px;
        }
        .mnv-input-row input[type="number"]:focus {
            border-color: #00ff00; outline: none;
        }
        .mnv-input-row .mnv-unit { font-size: 10px; color: #006600; width: 80px; }
        .mnv-input-row select {
            flex: 1;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #005500;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 3px;
        }
        .mnv-input-row select:focus {
            border-color: #00ff00; outline: none;
        }
        .mnv-input-row select option {
            background: #0a0f0a; color: #00ff00;
        }
        .mnv-sep { border-top: 1px solid #003300; margin: 8px 0; }
        .mnv-info-row {
            display: flex; justify-content: space-between;
            font-size: 12px; margin-bottom: 4px;
        }
        .mnv-info-row .mnv-label { color: #00aa00; }
        .mnv-info-row .mnv-value { color: #00ff00; font-weight: bold; }
        .mnv-footer {
            padding: 10px 16px;
            border-top: 1px solid #005500;
            display: flex; gap: 6px; justify-content: center;
            flex-wrap: wrap;
        }
        .mnv-btn {
            background: rgba(0, 40, 0, 0.8);
            border: 1px solid #005500;
            color: #00cc00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .mnv-btn:hover { border-color: #00ff00; color: #00ff00; background: rgba(0, 60, 0, 0.8); }
        .mnv-btn.mnv-cancel { border-color: #550000; color: #aa0000; }
        .mnv-btn.mnv-cancel:hover { border-color: #ff0000; color: #ff0000; }
        .mnv-btn.mnv-execute { border-color: #555500; color: #aaaa00; }
        .mnv-btn.mnv-execute:hover { border-color: #ffff00; color: #ffff00; }
        .mnv-helpers {
            display: flex; gap: 4px; margin: 6px 0;
        }
        .mnv-helper-btn {
            flex: 1;
            background: rgba(0, 30, 40, 0.8);
            border: 1px solid #004455;
            color: #00aacc;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
        }
        .mnv-helper-btn:hover { border-color: #00ccff; color: #00ccff; }
        .mnv-solvers {
            display: flex; gap: 4px; margin: 4px 0 6px;
        }
        .mnv-solver-btn {
            flex: 1;
            background: rgba(40, 25, 0, 0.8);
            border: 1px solid #664400;
            color: #cc8800;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
        }
        .mnv-solver-btn:hover { border-color: #ffaa00; color: #ffaa00; }
        .mnv-solver-btn.active { border-color: #ffaa00; color: #ffaa00; background: rgba(60, 40, 0, 0.9); }
        #mnvSolverPanel {
            background: rgba(20, 15, 0, 0.8);
            border: 1px solid #443300;
            border-radius: 3px;
            padding: 8px 10px;
            margin: 6px 0;
        }
        #mnvSolverPanel .slv-row {
            display: flex; align-items: center;
            margin-bottom: 6px; gap: 6px;
        }
        #mnvSolverPanel .slv-row label {
            width: 70px; font-size: 11px; color: #cc8800;
            text-align: right; flex-shrink: 0;
        }
        #mnvSolverPanel .slv-row input,
        #mnvSolverPanel .slv-row select {
            flex: 1;
            background: rgba(20, 10, 0, 0.8);
            border: 1px solid #443300;
            color: #ffcc00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 3px 5px;
            border-radius: 3px;
        }
        #mnvSolverPanel .slv-row input:focus,
        #mnvSolverPanel .slv-row select:focus {
            border-color: #ffaa00; outline: none;
        }
        #mnvSolverPanel .slv-row select option {
            background: #1a0f00; color: #ffcc00;
        }
        #mnvSolverPanel .slv-row .slv-unit {
            font-size: 9px; color: #665500; width: 30px; flex-shrink: 0;
        }
        #mnvSolverPanel .slv-compute {
            background: rgba(40, 25, 0, 0.8);
            border: 1px solid #664400;
            color: #ffaa00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            margin-top: 4px;
        }
        #mnvSolverPanel .slv-compute:hover { border-color: #ffcc00; color: #ffcc00; }
        #mnvSolverPanel .slv-result {
            font-size: 11px; color: #cc8800; margin-top: 6px;
            border-top: 1px solid #332200; padding-top: 4px;
        }
        #mnvSolverPanel .slv-result .slv-val { color: #ffcc00; font-weight: bold; }

        /* ===================== HUD BRIGHTNESS SLIDER ===================== */
        .settings-range-row {
            display: flex;
            align-items: center;
            padding: 4px 14px;
            gap: 6px;
            color: #00aa00;
            font-size: 12px;
        }
        .settings-range-row .settings-label { flex-shrink: 0; }
        .settings-range-row input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #003300;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        .settings-range-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #00ff00;
            border: 1px solid #005500;
            cursor: pointer;
        }
        .settings-range-row input[type="range"]::-moz-range-thumb {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #00ff00;
            border: 1px solid #005500;
            cursor: pointer;
        }
        .settings-range-row input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 2px;
        }
        .settings-range-val {
            color: #00ff00;
            font-size: 10px;
            min-width: 28px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        /* ===================== ALL ON / ALL OFF BUTTONS ===================== */
        .settings-section-header {
            display: flex;
            align-items: center;
            padding: 3px 14px;
            gap: 6px;
        }
        .settings-section-header .settings-section-title {
            flex: 1;
            padding: 0;
        }
        .hud-toggle-btn {
            background: rgba(0, 40, 0, 0.6);
            border: 1px solid #005500;
            color: #00aa00;
            font-family: 'Courier New', monospace;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 2px;
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: border-color 0.1s, color 0.1s;
            white-space: nowrap;
        }
        .hud-toggle-btn:hover {
            border-color: #00ff00;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <canvas id="hudCanvas"></canvas>

    <!-- Status Bar -->
    <div id="statusBar" class="panel" style="display:none">
        <span id="playerNameDisplay">---</span> |
        <span id="simTime">0:00</span> |
        <span id="timeWarpDisplay">1x</span> |
        <span id="pauseStatus">RUNNING</span> |
        <span id="propModeDisplay">---</span> |
        <span id="pointingModeDisplay" style="color:#44ccff"></span>
        <span id="regimeDisplay" style="font-weight:bold;color:#00ff00">ATMOSPHERIC</span>
    </div>

    <!-- Mode Indicator -->
    <div id="modeIndicator">PLANNER MODE - Press M to return to cockpit</div>

    <!-- Flight Data Panel (Left) -->
    <div id="flightDataPanel" class="panel" style="display:none">
        <h3>Flight Data</h3>
        <div class="data-row"><span class="data-label">IAS</span><span class="data-value" id="fdIAS">0 KT</span></div>
        <div class="data-row"><span class="data-label">TAS</span><span class="data-value" id="fdTAS">0 KT</span></div>
        <div class="data-row"><span class="data-label">Mach</span><span class="data-value" id="fdMach">0.00</span></div>
        <div class="data-row"><span class="data-label">V Inertial</span><span class="data-value" id="fdVInertial">---</span></div>
        <div class="data-row"><span class="data-label">ALT MSL</span><span class="data-value" id="fdAlt">0 FT</span></div>
        <div class="data-row"><span class="data-label">ALT AGL</span><span class="data-value" id="fdAGL">0 FT</span></div>
        <div class="data-row"><span class="data-label">HDG</span><span class="data-value" id="fdHdg">000</span></div>
        <div class="data-row"><span class="data-label">VS</span><span class="data-value" id="fdVS">0 FPM</span></div>
        <div class="data-row"><span class="data-label">G-Load</span><span class="data-value" id="fdG">1.0</span></div>
        <div class="data-row"><span class="data-label">AoA</span><span class="data-value" id="fdAoA">0.0</span></div>
        <div class="data-row"><span class="data-label">Throttle</span><span class="data-value" id="fdThr">0%</span></div>
        <div class="data-row"><span class="data-label">Orb V%</span><span class="data-value" id="fdOrbV">0%</span></div>
        <div class="data-row"><span class="data-label">Dyn Q</span><span class="data-value" id="fdDynQ">---</span></div>
        <div class="data-row"><span class="data-label">Lat</span><span class="data-value" id="fdLat">0.0000</span></div>
        <div class="data-row"><span class="data-label">Lon</span><span class="data-value" id="fdLon">0.0000</span></div>
    </div>

    <!-- Systems Panel (Right) -->
    <div id="systemsPanel" class="panel" style="display:none">
        <h3>Systems</h3>
        <div class="data-row"><span class="data-label">Engine</span><span class="data-value" id="sysEngine">OFF</span></div>
        <div class="data-row"><span class="data-label">Propulsion</span><span class="data-value" id="sysProp">---</span></div>
        <div class="data-row"><span class="data-label">Gear</span><span class="data-value" id="sysGear">DOWN</span></div>
        <div class="data-row"><span class="data-label">Flaps</span><span class="data-value" id="sysFlaps">UP</span></div>
        <div class="data-row"><span class="data-label">Spd Brake</span><span class="data-value" id="sysSpeedBrake">IN</span></div>
        <div class="data-row"><span class="data-label">Brakes</span><span class="data-value" id="sysBrakes">OFF</span></div>
        <div class="data-row"><span class="data-label">Regime</span><span class="data-value" id="sysRegime">ATMOSPHERIC</span></div>

        <h3 style="margin-top:10px">Autopilot</h3>
        <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="apStatus">OFF</span></div>
        <div class="data-row"><span class="data-label">Mode</span><span class="data-value" id="apMode">---</span></div>
        <div class="data-row"><span class="data-label">Target ALT</span><span class="data-value" id="apAlt">---</span></div>
        <div class="data-row"><span class="data-label">Target HDG</span><span class="data-value" id="apHdg">---</span></div>
        <div class="data-row"><span class="data-label">Target SPD</span><span class="data-value" id="apSpd">---</span></div>

        <h3 style="margin-top:10px">Camera</h3>
        <div class="data-row"><span class="data-label">Mode</span><span class="data-value" id="camMode">CHASE</span></div>
    </div>

    <!-- Orbital Elements Panel -->
    <div id="orbitalPanel" class="panel">
        <h3>Orbital Elements</h3>
        <div class="data-row"><span class="data-label">Apoapsis</span><span class="data-value" id="orbAP">---</span></div>
        <div class="data-row"><span class="data-label">Periapsis</span><span class="data-value" id="orbPE">---</span></div>
        <div class="data-row"><span class="data-label">Incl</span><span class="data-value" id="orbINC">---</span></div>
        <div class="data-row"><span class="data-label">Ecc</span><span class="data-value" id="orbECC">---</span></div>
        <div class="data-row"><span class="data-label">SMA</span><span class="data-value" id="orbSMA">---</span></div>
        <div class="data-row"><span class="data-label">Period</span><span class="data-value" id="orbPeriod">---</span></div>
        <div class="data-row"><span class="data-label">RAAN</span><span class="data-value" id="orbRAAN">---</span></div>
        <div class="data-row"><span class="data-label">Arg PE</span><span class="data-value" id="orbArgPE">---</span></div>
        <div class="data-row"><span class="data-label">True Anom</span><span class="data-value" id="orbTA">---</span></div>
        <div class="data-row"><span class="data-label">T to AP</span><span class="data-value" id="orbTAP">---</span></div>
        <div class="data-row"><span class="data-label">T to PE</span><span class="data-value" id="orbTPE">---</span></div>
        <div class="data-row"><span class="data-label">T to AN</span><span class="data-value" id="orbTAN">---</span></div>
        <div class="data-row"><span class="data-label">T to DN</span><span class="data-value" id="orbTDN">---</span></div>
        <div class="data-row"><span class="data-label">T ν=90°</span><span class="data-value" id="orbTTA90">---</span></div>
        <div class="data-row"><span class="data-label">T ν=270°</span><span class="data-value" id="orbTTA270">---</span></div>
        <h3 style="margin-top:10px">Maneuver Node</h3>
        <div class="data-row"><span class="data-label">dV</span><span class="data-value" id="nodeDV">---</span></div>
        <div class="data-row"><span class="data-label">Burn T</span><span class="data-value" id="nodeBurnT">---</span></div>
        <div class="data-row"><span class="data-label">Post AP</span><span class="data-value" id="nodePostAP">---</span></div>
        <div class="data-row"><span class="data-label">Post PE</span><span class="data-value" id="nodePostPE">---</span></div>
    </div>

    <!-- Entity List Panel (Bottom Right) -->
    <div id="entityListPanel" class="panel" style="display:none">
        <h3>Entities</h3>
        <div id="entityListInner"></div>
    </div>

    <!-- Controls Help (Bottom, toggled with H) -->
    <div id="controlsHelp" class="panel">
        <h3>Controls (Press H to hide)</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="key-grid">
                <span class="key">W / S</span><span class="key-desc">Throttle up/down</span>
                <span class="key">Down / Up</span><span class="key-desc">Pitch up/down</span>
                <span class="key">Left / Right</span><span class="key-desc">Roll left/right</span>
                <span class="key">Q / D</span><span class="key-desc">Yaw left/right</span>
                <span class="key">E</span><span class="key-desc">Engine start/stop</span>
                <span class="key">G</span><span class="key-desc">Toggle gear</span>
            </div>
            <div class="key-grid">
                <span class="key">F</span><span class="key-desc">Toggle flaps</span>
                <span class="key">X</span><span class="key-desc">Speed brake</span>
                <span class="key">B</span><span class="key-desc">Wheel brakes</span>
                <span class="key">Esc</span><span class="key-desc">Pause</span>
                <span class="key">A</span><span class="key-desc">Toggle autopilot</span>
                <span class="key">C</span><span class="key-desc">Cycle camera</span>
                <span class="key">M</span><span class="key-desc">Toggle planner mode</span>
                <span class="key">P</span><span class="key-desc">Engine selection panel</span>
                <span class="key">T / Shift+T</span><span class="key-desc">Trim nose up/down</span>
            </div>
            <div class="key-grid">
                <span class="key" style="color:#00ffff">Combat:</span><span class="key-desc"></span>
                <span class="key">Space</span><span class="key-desc">Fire / activate weapon</span>
                <span class="key">R</span><span class="key-desc">Cycle weapon</span>
                <span class="key">V</span><span class="key-desc">Cycle sensor (EO/IR)</span>
                <span class="key">I</span><span class="key-desc">Cycle pointing mode</span>
                <span class="key">L</span><span class="key-desc">Pointing panel</span>
            </div>
            <div class="key-grid">
                <span class="key">+ / -</span><span class="key-desc">Time warp</span>
                <span class="key">H</span><span class="key-desc">Toggle controls help</span>
                <span class="key">N</span><span class="key-desc">Create node (opens dialog)</span>
                <span class="key">Del</span><span class="key-desc">Delete maneuver node</span>
                <span class="key">Enter</span><span class="key-desc">Quick-execute node (impulse)</span>
                <span class="key">1 / 2 / 3</span><span class="key-desc">Toggle panels</span>
                <span class="key">O</span><span class="key-desc">Toggle orbital panel</span>
                <span class="key">Tab</span><span class="key-desc">Hide/show all panels</span>
            </div>
            <div class="key-grid">
                <span class="key" style="color:#ff8800">Planner:</span><span class="key-desc"></span>
                <span class="key">M</span><span class="key-desc">Enter/exit planner</span>
                <span class="key">Click</span><span class="key-desc">Click orbit to add node</span>
                <span class="key">N</span><span class="key-desc">Node at current pos</span>
                <span class="key">P</span><span class="key-desc">Change engine (burn time)</span>
                <span class="key">Esc</span><span class="key-desc">Cancel auto-execute</span>
            </div>
        </div>
    </div>

    <!-- Settings Gear -->
    <div id="settingsBtn">&#9881;</div>
    <div id="settingsDropdown">
        <div class="settings-item active" data-panel="flightData">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Flight Data</span>
            <span class="settings-key">1</span>
        </div>
        <div class="settings-item active" data-panel="systems">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Systems</span>
            <span class="settings-key">2</span>
        </div>
        <div class="settings-item" data-panel="orbital">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Orbital Elements</span>
            <span class="settings-key">O</span>
        </div>
        <div class="settings-item active" data-panel="entityList">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Entity List</span>
            <span class="settings-key">3</span>
        </div>
        <div class="settings-item" data-panel="help">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Controls Help</span>
            <span class="settings-key">H</span>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-item active" data-panel="statusBar">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Status Bar</span>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-title">Orbit Traces</div>
        <div class="settings-item active" data-trace="ecef">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">ECEF Orbit (ground track)</span>
        </div>
        <div class="settings-item" data-trace="eci">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">ECI Orbit (inertial)</span>
        </div>
        <div class="settings-row">
            <span class="settings-label">Revolutions</span>
            <select id="orbitRevSelect">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-title">History Trail</div>
        <div class="settings-item active" data-trace="trail">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Trail</span>
        </div>
        <div class="settings-row">
            <span class="settings-label">Duration (sec)</span>
            <input type="number" id="trailDuration" value="0" min="0" step="30" title="0 = infinite">
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-header">
            <div class="settings-section-title">HUD Elements</div>
            <button class="hud-toggle-btn" id="hudAllOn">All On</button>
            <button class="hud-toggle-btn" id="hudAllOff">All Off</button>
        </div>
        <div class="settings-range-row">
            <span class="settings-label">Brightness</span>
            <input type="range" id="hudBrightness" min="30" max="200" value="100" step="5">
            <span class="settings-range-val" id="hudBrightnessVal">100%</span>
        </div>
        <div class="settings-item active" data-hud="hud">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">HUD (master)</span>
        </div>
        <div class="settings-item active" data-hud="speedTape">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Speed Tape</span>
        </div>
        <div class="settings-item active" data-hud="altTape">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Altitude Tape</span>
        </div>
        <div class="settings-item active" data-hud="heading">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Heading</span>
        </div>
        <div class="settings-item active" data-hud="pitchLadder">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Pitch Ladder</span>
        </div>
        <div class="settings-item active" data-hud="fpm">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Flight Path Marker</span>
        </div>
        <div class="settings-item active" data-hud="gMeter">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">G-Meter</span>
        </div>
        <div class="settings-item active" data-hud="engineFuel">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Engine / Fuel</span>
        </div>
        <div class="settings-item active" data-hud="weapons">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Weapons / Target</span>
        </div>
        <div class="settings-item active" data-hud="warnings">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Warnings / Status</span>
        </div>
        <div class="settings-item active" data-hud="orbital">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Orbital / Navball</span>
        </div>
        <div class="settings-item active" data-hud="minimap">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Minimap Scope</span>
        </div>
        <div class="settings-item active" data-hud="coordinates">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Coordinates</span>
        </div>
        <div class="settings-item active" data-hud="warpIndicator">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Time Warp</span>
        </div>
        <div class="settings-item active" data-hud="approachAids">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Approach Aids</span>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-title">Subsystems</div>
        <div class="settings-item active" data-subsystem="audio">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Audio Engine</span>
        </div>
        <div class="settings-item active" data-subsystem="visualfx">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Visual Effects</span>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-title">Entity Display</div>
        <div class="settings-item active" data-viz="globalOrbits">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">All Orbits</span>
        </div>
        <div class="settings-item active" data-viz="globalTrails">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">All Trails</span>
        </div>
        <div class="settings-item active" data-viz="globalLabels">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">All Labels</span>
        </div>
        <div class="settings-item active" data-viz="globalSensors">
            <div class="settings-check">&#10003;</div>
            <span class="settings-label">Display Sensors</span>
        </div>
        <div class="settings-sep"></div>
        <div class="settings-section-title">Groups</div>
        <div id="vizGroupList"></div>
    </div>

    <!-- Engine Selection Panel (P key toggles) -->
    <div id="enginePanel">
        <div class="ep-title">ENGINE SELECT <span class="ep-hint">[P] close</span></div>
        <div id="enginePanelContent"></div>
    </div>

    <!-- Pointing Mode Panel (L key toggles) -->
    <div id="pointingPanel">
        <div class="ep-title" style="color:#00ddff">POINTING MODE <span class="ep-hint" style="color:#005566">[I] cycle &middot; [L] panel</span></div>
        <div id="pointingPanelContent"></div>
    </div>

    <!-- ===================== MANEUVER DIALOG ===================== -->
    <div id="maneuverDialog">
        <div class="mnv-header">
            <h3>MANEUVER NODE</h3>
            <div class="mnv-time">
                <span id="mnvTimeToNode">T- 00:00</span> &nbsp;|&nbsp;
                <span id="mnvBurnAt">Burn @ 00:00:00</span>
            </div>
        </div>
        <div class="mnv-body">
            <div class="mnv-input-row">
                <label>Prograde</label>
                <input type="number" id="mnvPrograde" value="0" step="1">
                <span class="mnv-unit">m/s (- retro)</span>
            </div>
            <div class="mnv-input-row">
                <label>Normal</label>
                <input type="number" id="mnvNormal" value="0" step="1">
                <span class="mnv-unit">m/s (- anti)</span>
            </div>
            <div class="mnv-input-row">
                <label>Radial</label>
                <input type="number" id="mnvRadial" value="0" step="1">
                <span class="mnv-unit">m/s (- = in)</span>
            </div>
            <div class="mnv-sep"></div>
            <div class="mnv-input-row">
                <label>Execute At</label>
                <select id="mnvExecTime">
                    <option value="current">Click Position</option>
                    <option value="apogee">Apogee</option>
                    <option value="perigee">Perigee</option>
                    <option value="asc_node">Ascending Node</option>
                    <option value="desc_node">Descending Node</option>
                    <option value="ta90">ν=90° (PE→AP mid)</option>
                    <option value="ta270">ν=270° (AP→PE mid)</option>
                    <option value="custom">Custom Time (s)</option>
                </select>
            </div>
            <div class="mnv-input-row" id="mnvCustomTimeRow" style="display:none">
                <label>T from now</label>
                <input type="number" id="mnvCustomTime" value="0" step="60">
                <span class="mnv-unit">seconds</span>
            </div>
            <div class="mnv-helpers">
                <button class="mnv-helper-btn" id="mnvCircAP">Circ @ AP</button>
                <button class="mnv-helper-btn" id="mnvCircPE">Circ @ PE</button>
            </div>
            <div class="mnv-solvers">
                <button class="mnv-solver-btn" id="mnvHohmann">Hohmann</button>
                <button class="mnv-solver-btn" id="mnvIntercept">Intercept</button>
                <button class="mnv-solver-btn" id="mnvNMC">NMC</button>
            </div>
            <div class="mnv-solvers">
                <button class="mnv-solver-btn" id="mnvOrbit">Orbit</button>
                <button class="mnv-solver-btn" id="mnvLagrange">Lagrange</button>
                <button class="mnv-solver-btn" id="mnvInclChg">Incl Chg</button>
            </div>
            <div class="mnv-solvers">
                <button class="mnv-solver-btn" id="mnvPlaneMatch">Plane Match</button>
                <button class="mnv-solver-btn" id="mnvPlanet">Planet</button>
            </div>
            <div id="mnvSolverPanel" style="display:none"></div>
            <div class="mnv-sep"></div>
            <div class="mnv-info-row">
                <span class="mnv-label">Total &Delta;V</span>
                <span class="mnv-value" id="mnvTotalDV">0.0 m/s</span>
            </div>
            <div class="mnv-info-row">
                <span class="mnv-label">Burn Time</span>
                <span class="mnv-value" id="mnvBurnTime">0.0s</span>
            </div>
            <div class="mnv-info-row">
                <span class="mnv-label">Engine</span>
                <span class="mnv-value" id="mnvEngine">ROCKET 5000kN</span>
            </div>
            <div class="mnv-info-row">
                <span class="mnv-label">Post-AP</span>
                <span class="mnv-value" id="mnvPostAP">-- km</span>
            </div>
            <div class="mnv-info-row">
                <span class="mnv-label">Post-PE</span>
                <span class="mnv-value" id="mnvPostPE">-- km</span>
            </div>
        </div>
        <div class="mnv-footer">
            <button class="mnv-btn" id="mnvAccept">Accept</button>
            <button class="mnv-btn" id="mnvWarpToT">Warp to T</button>
            <button class="mnv-btn mnv-execute" id="mnvExecute">Execute</button>
            <button class="mnv-btn mnv-cancel" id="mnvCancel">Cancel</button>
        </div>
    </div>

    <!-- ===================== SPLASH SCREEN ===================== -->
    <div id="splashOverlay">
        <h1>LIVE SIM</h1>
        <div class="splash-subtitle">ALL-DOMAIN SIMULATION</div>

        <!-- Step 1: Select sim file -->
        <div id="splashStep1">
            <div class="splash-section-title">Select Scenario</div>
            <div id="simFileList"></div>
            <div id="simFileStatus" class="splash-status">Loading sim files...</div>
        </div>

        <!-- Step 2: Select entity -->
        <div id="splashStep2" style="display:none">
            <div class="splash-back-link" id="btnBackToSims">&lt; Back to scenario list</div>
            <div id="entityPickStatus" class="splash-status"></div>
            <div style="display:flex;gap:8px;margin-top:12px;margin-bottom:12px">
                <button class="splash-btn" id="btnObserve" style="flex:1;font-size:16px;padding:12px">OBSERVE</button>
                <button class="splash-btn primary" id="btnLaunchCockpit" disabled style="flex:1;font-size:16px;padding:12px">LAUNCH</button>
            </div>
            <div id="entityPickToggle" style="display:none;cursor:pointer;color:#4af;font-size:12px;margin-bottom:6px;user-select:none">
                &#9654; Select entity to control <span id="entityPickCount" style="color:#888"></span>
            </div>
            <div id="entityPickList" style="display:none;max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- Loading Overlay (shown during scenario build) -->
    <div id="loadingOverlay">
        <h1>LIVE SIM</h1>
        <div id="loadingStatus">Initializing...</div>
        <div id="loadingError"></div>
    </div>

    <!-- Quest/Mission Objective Panel -->
    <div id="questPanel" class="panel" style="display:none; top:70px; left:50%; transform:translateX(-50%);
         border-color:#ffaa00; min-width:320px; max-width:500px; text-align:center; z-index:25;">
        <h3 style="color:#ffcc00; border-bottom-color:#664400;">MISSION</h3>
        <div id="questObjective" style="color:#ffcc00; font-size:14px; line-height:1.4;">---</div>
        <div id="questHint" style="color:#aa8800; font-size:11px; margin-top:4px;">---</div>
        <div id="questProgress" style="color:#886600; font-size:10px; margin-top:6px; border-top:1px solid #664400; padding-top:4px;">---</div>
    </div>

    <!-- Temporary Message Overlay -->
    <div id="msgOverlay"></div>

    <!-- Scripts: Cesium config -->
    <script src="cesium_config.js"></script>

    <!-- Scripts: Standalone sim modules (reused) -->
    <script src="js/fighter_atmosphere.js"></script>
    <script src="js/fighter_sim_engine.js"></script>
    <script src="js/fighter_hud.js"></script>
    <script src="js/fighter_autopilot.js"></script>
    <script src="js/fighter_weapons.js"></script>
    <script src="js/spaceplane_orbital.js"></script>
    <script src="js/spaceplane_hud.js"></script>
    <script src="js/framework/solar_system_engine.js"></script>
    <script src="js/spaceplane_planner.js"></script>
    <script src="js/gamepad_input.js"></script>

    <!-- Scripts: ECS Framework -->
    <script src="js/framework/constants.js"></script>
    <script src="js/framework/sim_rng.js"></script>
    <script src="js/framework/ecs.js"></script>
    <script src="js/framework/registry.js"></script>
    <script src="js/framework/sensor_system.js"></script>
    <script src="js/framework/weapon_system.js"></script>
    <script src="js/framework/event_system.js"></script>
    <script src="js/framework/systems.js"></script>
    <script src="js/framework/tle_parser.js"></script>
    <script src="js/framework/loader.js"></script>

    <!-- Scripts: ECS Components -->
    <script src="js/components/physics/flight3dof.js"></script>
    <script src="js/components/physics/naval.js"></script>
    <script src="js/components/physics/orbital_2body.js"></script>
    <script src="js/builder/sensor_view_mode.js"></script>
    <script src="js/components/control/player_input.js"></script>
    <script src="js/components/ai/waypoint_patrol.js"></script>
    <script src="js/components/ai/intercept.js"></script>
    <script src="js/components/ai/orbital_combat.js"></script>
    <script src="js/components/sensors/radar.js"></script>
    <script src="js/components/weapons/sam_battery.js"></script>
    <script src="js/components/weapons/fighter_loadout.js"></script>
    <script src="js/components/weapons/a2a_missile.js"></script>
    <script src="js/components/weapons/kinetic_kill.js"></script>
    <script src="js/components/visual/cesium_entity.js"></script>
    <script src="js/components/visual/satellite_visual.js"></script>
    <script src="js/components/visual/ground_station.js"></script>
    <script src="js/components/visual/radar_coverage.js"></script>
    <script src="js/components/visual/sensor_footprint.js"></script>

    <!-- Scripts: Simulation subsystems -->
    <script src="js/model_map.js"></script>
    <script src="js/audio_engine.js"></script>
    <script src="js/visual_effects.js"></script>
    <script src="js/ew_system.js"></script>
    <script src="js/weather_system.js"></script>
    <script src="js/naval_physics.js"></script>

    <!-- Scripts: Live Sim Engine -->
    <script src="js/live_sim_engine.js"></script>

    <script>
    // =========================================================================
    // LIVE SIM VIEWER — SPLASH SCREEN + MAIN
    // =========================================================================
    'use strict';

    (function() {
        var _params = new URLSearchParams(window.location.search);
        var _preselectedSim = _params.get('sim');      // e.g. "my_scenario.sim"
        var _preselectedScenario = _params.get('scenario'); // legacy: direct scenario path
        var _preselectedPlayer = _params.get('player');

        var _selectedSimPath = null;
        var _selectedPlayerId = null;
        var _scenarioJson = null;
        var _viewer = null;

        // =====================================================================
        // Splash Step 1: Load sim file list
        // =====================================================================
        function initSplash() {
            // If legacy ?scenario= param is used, skip splash and go straight to launch
            if (_preselectedScenario) {
                _selectedSimPath = _preselectedScenario;
                if (_preselectedPlayer) {
                    _selectedPlayerId = _preselectedPlayer;
                    launchSim();
                } else {
                    // Load scenario to show entity picker
                    loadScenarioForEntityPick(_preselectedScenario);
                }
                return;
            }

            // If ?sim= param, pre-select that sim file
            if (_preselectedSim) {
                _selectedSimPath = 'sims/' + _preselectedSim;
                loadScenarioForEntityPick(_selectedSimPath);
                return;
            }

            // Normal flow: fetch sim list
            loadSimList();
        }

        function loadSimList() {
            var statusEl = document.getElementById('simFileStatus');
            var listEl = document.getElementById('simFileList');
            statusEl.textContent = 'Loading sim files...';

            fetch('/api/sim/list')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.error) {
                        statusEl.textContent = '';
                        statusEl.innerHTML = '<span class="splash-error">' + data.error + '</span>';
                        return;
                    }

                    var sims = data.sims || [];
                    if (sims.length === 0) {
                        statusEl.textContent = '';
                        listEl.innerHTML = '<div class="splash-empty">No sim files found. ' +
                            'Use the Scenario Builder to create and save sims.</div>';
                        // Also show built-in scenario files
                        loadBuiltinScenarios(listEl, statusEl);
                        appendTLECatalogCard(listEl);
                        return;
                    }

                    statusEl.textContent = sims.length + ' sim file' + (sims.length > 1 ? 's' : '') + ' available';
                    renderSimList(sims, listEl);

                    // Also append built-in scenarios section
                    loadBuiltinScenarios(listEl, null);

                    // Append TLE catalog card
                    appendTLECatalogCard(listEl);
                })
                .catch(function(err) {
                    statusEl.textContent = '';
                    statusEl.innerHTML = '<span class="splash-error">Failed to load: ' + err.message + '</span>';
                    // Fallback: show built-in scenarios
                    loadBuiltinScenarios(listEl, statusEl);
                    appendTLECatalogCard(listEl);
                });
        }

        function renderSimList(sims, container) {
            var html = '';
            for (var i = 0; i < sims.length; i++) {
                var sim = sims[i];
                var dateStr = sim.modified ? new Date(sim.modified * 1000).toLocaleDateString() : '';
                var sizeStr = sim.size > 1024 ? (sim.size / 1024).toFixed(0) + ' KB' : sim.size + ' B';
                html += '<div class="sim-card" data-path="' + sim.path + '">' +
                    '<div class="sim-card-name">' + _escHtml(sim.name) + '</div>' +
                    '<div class="sim-card-meta">' +
                        '<span>' + sim.entityCount + ' entities</span>' +
                        '<span>' + sizeStr + '</span>' +
                        '<span>' + dateStr + '</span>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html + container.innerHTML;

            // Bind clicks
            var cards = container.querySelectorAll('.sim-card');
            for (var j = 0; j < cards.length; j++) {
                cards[j].addEventListener('click', function() {
                    var path = this.getAttribute('data-path');
                    _selectedSimPath = path;
                    loadScenarioForEntityPick(path);
                });
            }
        }

        function loadBuiltinScenarios(container, statusEl) {
            // Offer some built-in scenario files as fallback
            var builtins = [
                { name: 'IADS Engagement', path: 'scenarios/demo_iads_engagement.json', entities: 10 },
                { name: 'Strike Package', path: 'scenarios/template_strike_package.json', entities: 8 },
                { name: 'Multi-Domain', path: 'scenarios/demo_multi_domain.json', entities: 9 },
                { name: 'GPS Coverage', path: 'scenarios/template_gps_coverage.json', entities: 10 },
                { name: 'Contested Orbit', path: 'scenarios/template_contested_orbit.json', entities: 7 },
            ];

            var heading = document.createElement('div');
            heading.className = 'splash-section-title';
            heading.style.marginTop = '24px';
            heading.textContent = 'Built-in Scenarios';
            container.appendChild(heading);

            for (var i = 0; i < builtins.length; i++) {
                var b = builtins[i];
                var card = document.createElement('div');
                card.className = 'sim-card';
                card.setAttribute('data-path', b.path);
                card.innerHTML = '<div class="sim-card-name">' + _escHtml(b.name) + '</div>' +
                    '<div class="sim-card-meta"><span>~' + b.entities + ' entities</span><span>built-in</span></div>';
                container.appendChild(card);

                card.addEventListener('click', (function(path) {
                    return function() {
                        _selectedSimPath = path;
                        loadScenarioForEntityPick(path);
                    };
                })(b.path));
            }

            if (statusEl) statusEl.textContent = '';
        }

        function appendTLECatalogCard(container) {
            var heading = document.createElement('div');
            heading.className = 'splash-section-title';
            heading.style.marginTop = '24px';
            heading.textContent = 'TLE Satellite Catalog';
            container.appendChild(heading);

            var card = document.createElement('div');
            card.className = 'sim-card';
            card.style.borderColor = '#44cc88';
            card.innerHTML = '<div class="sim-card-name" style="color:#44cc88">\u2606 TLE CATALOG</div>' +
                '<div class="sim-card-meta"><span>14,304 satellites</span><span>Pick constellations</span></div>';
            container.appendChild(card);

            card.addEventListener('click', function() {
                openTLEConstellationPicker();
            });
        }

        function openTLEConstellationPicker() {
            // Create modal for constellation picker
            var modal = document.createElement('div');
            modal.id = 'tlePickerModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;' +
                'background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;';

            var panel = document.createElement('div');
            panel.style.cssText = 'background:#1a1a2e;border:1px solid #44cc88;border-radius:8px;' +
                'padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;color:#eee;font-family:monospace;';
            panel.innerHTML = '<h3 style="color:#44cc88;margin:0 0 12px">SELECT CONSTELLATIONS</h3>' +
                '<div id="tleConstellationList" style="margin-bottom:12px">Loading catalog...</div>' +
                '<div style="display:flex;gap:8px">' +
                '<button id="tlePickAll" class="splash-btn" style="flex:1;padding:6px;font-size:11px">SELECT ALL</button>' +
                '<button id="tlePickNone" class="splash-btn" style="flex:1;padding:6px;font-size:11px">CLEAR</button>' +
                '<button id="tlePickLoad" class="splash-btn primary" style="flex:1;padding:6px">LOAD</button>' +
                '<button id="tlePickCancel" class="splash-btn" style="flex:1;padding:6px;font-size:11px">CANCEL</button></div>';
            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Fetch catalog
            fetch('/api/tle/catalog')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var list = document.getElementById('tleConstellationList');
                    var constellations = data.constellations || [];
                    var html = '';
                    for (var i = 0; i < constellations.length; i++) {
                        var c = constellations[i];
                        // Pre-select common ones
                        var preselected = ['GPS', 'IRIDIUM', 'GALILEO'].indexOf(c.name) >= 0;
                        html += '<label style="display:block;padding:4px 0;cursor:pointer;color:#ccc">' +
                            '<input type="checkbox" class="tle-const-check" data-name="' + c.name + '"' +
                            (preselected ? ' checked' : '') + '> ' +
                            '<span style="color:' + (preselected ? '#44cc88' : '#999') + '">' +
                            c.name + '</span> <span style="color:#666">(' + c.count + ')</span></label>';
                    }
                    list.innerHTML = html;

                    // Wire select all / clear
                    document.getElementById('tlePickAll').onclick = function() {
                        list.querySelectorAll('.tle-const-check').forEach(function(cb) { cb.checked = true; });
                    };
                    document.getElementById('tlePickNone').onclick = function() {
                        list.querySelectorAll('.tle-const-check').forEach(function(cb) { cb.checked = false; });
                    };
                })
                .catch(function(err) {
                    document.getElementById('tleConstellationList').innerHTML =
                        '<span style="color:#f44">Failed to load catalog: ' + err.message + '</span>';
                });

            // Cancel
            document.getElementById('tlePickCancel').onclick = function() {
                document.body.removeChild(modal);
            };

            // Load selected constellations
            document.getElementById('tlePickLoad').onclick = function() {
                var checks = document.querySelectorAll('.tle-const-check:checked');
                var names = [];
                checks.forEach(function(cb) { names.push(cb.getAttribute('data-name')); });
                if (names.length === 0) return;
                document.body.removeChild(modal);
                loadTLEConstellations(names);
            };
        }

        function loadTLEConstellations(names) {
            var statusEl = document.getElementById('simFileStatus');
            statusEl.textContent = 'Loading ' + names.length + ' constellation(s)...';

            // Fetch all selected constellations in parallel
            var promises = names.map(function(name) {
                return fetch('/api/tle/constellation/' + encodeURIComponent(name))
                    .then(function(r) { return r.json(); });
            });

            Promise.all(promises).then(function(results) {
                // Build scenario JSON from TLE data
                var entities = [];
                for (var i = 0; i < results.length; i++) {
                    var constData = results[i];
                    var sats = constData.satellites || [];
                    for (var j = 0; j < sats.length; j++) {
                        var sat = sats[j];
                        entities.push({
                            id: 'tle_' + sat.norad,
                            name: sat.name,
                            type: 'satellite',
                            team: 'neutral',
                            vizCategory: constData.name,
                            initialState: {},
                            components: {
                                physics: {
                                    type: 'orbital_2body',
                                    source: 'tle',
                                    tle_line1: sat.line1,
                                    tle_line2: sat.line2
                                },
                                visual: { type: 'satellite', pixelSize: 4, orbitPath: false, groundTrack: false, apPeMarkers: false }
                            }
                        });
                    }
                }

                var scenario = {
                    metadata: { name: 'TLE Catalog: ' + names.join(', '), version: '2.0' },
                    environment: { maxTimeWarp: 10000 },
                    entities: entities,
                    camera: { mode: 'earth', range: 25000000 }
                };

                // Write to temp sim file via API
                var blob = new Blob([JSON.stringify(scenario)], { type: 'application/json' });
                fetch('/api/sim/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: '_tle_catalog', scenario: scenario })
                }).then(function(resp) {
                    return resp.json();
                }).then(function(result) {
                    if (result.error) throw new Error(result.error);
                    statusEl.textContent = entities.length + ' satellites loaded from ' + names.length + ' constellation(s)';
                    _selectedSimPath = result.path || 'sims/tle_catalog.sim';
                    // Go to entity picker (which will show OBSERVE as primary option)
                    loadScenarioForEntityPick(_selectedSimPath);
                }).catch(function(err) {
                    // Fallback: create in-memory scenario URL
                    var url = URL.createObjectURL(blob);
                    _selectedSimPath = url;
                    statusEl.textContent = entities.length + ' satellites loaded';
                    loadScenarioForEntityPick(_selectedSimPath);
                });
            }).catch(function(err) {
                statusEl.innerHTML = '<span class="splash-error">Failed: ' + err.message + '</span>';
            });
        }

        // =====================================================================
        // Splash Step 2: Load scenario and show entity picker
        // =====================================================================
        function loadScenarioForEntityPick(path) {
            document.getElementById('splashStep1').style.display = 'none';
            document.getElementById('splashStep2').style.display = 'block';

            var statusEl = document.getElementById('entityPickStatus');
            var listEl = document.getElementById('entityPickList');
            var launchBtn = document.getElementById('btnLaunchCockpit');
            var toggleEl = document.getElementById('entityPickToggle');
            var countEl = document.getElementById('entityPickCount');

            statusEl.textContent = 'Loading scenario...';
            listEl.innerHTML = '';
            listEl.style.display = 'none';
            toggleEl.style.display = 'none';
            launchBtn.disabled = true;
            _selectedPlayerId = null;

            fetch(path)
                .then(function(r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(function(json) {
                    _scenarioJson = json;

                    var entities = json.entities || [];
                    if (entities.length === 0) {
                        statusEl.innerHTML = '<span class="splash-error">No entities in scenario</span>';
                        return;
                    }

                    // Find entities with physics (controllable)
                    var controllable = [];
                    var others = [];
                    for (var i = 0; i < entities.length; i++) {
                        var ent = entities[i];
                        var comps = ent.components || {};
                        var physType = comps.physics && comps.physics.type;
                        if (physType === 'flight3dof' || physType === 'orbital_2body') {
                            controllable.push(ent);
                        } else {
                            others.push(ent);
                        }
                    }

                    // Enable observe button always when scenario loaded
                    var observeBtn = document.getElementById('btnObserve');
                    if (observeBtn) observeBtn.disabled = false;

                    statusEl.textContent = entities.length + ' entities (' + controllable.length + ' controllable)';

                    if (controllable.length === 0) {
                        return;
                    }

                    // Show the collapsible toggle for entity selection
                    countEl.textContent = '(' + controllable.length + ')';
                    toggleEl.style.display = 'block';

                    // Render entities into the hidden list
                    renderEntityPicker(controllable, listEl, launchBtn);

                    // Wire toggle click to expand/collapse
                    toggleEl.onclick = function() {
                        var open = listEl.style.display !== 'none';
                        listEl.style.display = open ? 'none' : 'block';
                        toggleEl.innerHTML = (open ? '&#9654;' : '&#9660;') +
                            ' Select entity to control <span style="color:#888">' + countEl.textContent + '</span>';
                    };

                    // Auto-select and auto-expand if only one controllable
                    if (controllable.length === 1) {
                        listEl.style.display = 'block';
                        toggleEl.innerHTML = '&#9660; Select entity to control <span style="color:#888">' + countEl.textContent + '</span>';
                    }
                })
                .catch(function(err) {
                    statusEl.innerHTML = '<span class="splash-error">Failed to load: ' + err.message + '</span>';
                });
        }

        function renderEntityPicker(entities, container, launchBtn) {
            var html = '';
            for (var i = 0; i < entities.length; i++) {
                var ent = entities[i];
                var comps = ent.components || {};
                var physType = comps.physics ? comps.physics.type : 'none';
                var physConfig = comps.physics && comps.physics.config ? comps.physics.config : '';
                var teamColor = ent.team === 'blue' ? '#4488ff' :
                    ent.team === 'red' ? '#ff4444' : '#888888';
                var physLabel = physType === 'flight3dof' ? (physConfig || 'aircraft').toUpperCase() :
                    physType === 'orbital_2body' ? 'ORBITAL' : physType.toUpperCase();

                var detailParts = [ent.team || 'neutral'];
                if (ent.type) detailParts.push(ent.type);
                // Show custom propulsion info
                if (ent._custom && ent._custom.propulsion) {
                    var modes = [];
                    var p = ent._custom.propulsion;
                    if (p.air) modes.push('Air');
                    if (p.hypersonic) modes.push('Hyper');
                    if (p.rocket) modes.push('Rocket');
                    if (p.ion) modes.push('Ion');
                    if (p.rcs) modes.push('RCS');
                    if (modes.length) detailParts.push(modes.join('/'));
                }
                // Show weapons info
                if (ent._custom && ent._custom.payloads) {
                    var plds = ent._custom.payloads;
                    var wpns = [];
                    if (plds.a2a) wpns.push('A2A');
                    if (plds.a2g) wpns.push('A2G');
                    if (plds.kkv) wpns.push('KKV');
                    if (plds.nuclear_warhead) wpns.push('NUCLEAR');
                    if (wpns.length) detailParts.push(wpns.join('/'));
                }

                html += '<div class="entity-card" data-id="' + _escHtml(ent.id) + '">' +
                    '<div class="team-dot" style="background:' + teamColor + '"></div>' +
                    '<div class="entity-card-info">' +
                        '<div class="entity-card-name">' + _escHtml(ent.name || ent.id) + '</div>' +
                        '<div class="entity-card-detail">' + detailParts.join(' | ') + '</div>' +
                    '</div>' +
                    '<div class="entity-card-physics">' + physLabel + '</div>' +
                '</div>';
            }
            container.innerHTML = html;

            // Bind clicks — single selection
            var cards = container.querySelectorAll('.entity-card');
            for (var j = 0; j < cards.length; j++) {
                cards[j].addEventListener('click', function() {
                    // Deselect all
                    for (var k = 0; k < cards.length; k++) cards[k].classList.remove('selected');
                    // Select this one
                    this.classList.add('selected');
                    _selectedPlayerId = this.getAttribute('data-id');
                    launchBtn.disabled = false;
                });
            }

            // Auto-select if only one
            if (entities.length === 1) {
                cards[0].classList.add('selected');
                _selectedPlayerId = entities[0].id;
                launchBtn.disabled = false;
            }
        }

        // =====================================================================
        // Launch
        // =====================================================================
        function launchSim() {
            // Hide splash, show loading
            document.getElementById('splashOverlay').style.display = 'none';
            var loadEl = document.getElementById('loadingOverlay');
            loadEl.style.display = 'flex';
            document.getElementById('loadingStatus').textContent = 'Building scenario...';

            // Init Cesium viewer
            try {
                _viewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayerPicker: true,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    infoBox: false,
                    selectionIndicator: false,
                    shadows: false,
                    shouldAnimate: true,
                });

                if (typeof setupTerrain === 'function') setupTerrain(_viewer);
                if (typeof setupImagery === 'function') setupImagery(_viewer);
                if (typeof addArcGISProviders === 'function') addArcGISProviders(_viewer);
                _viewer.scene.globe.enableLighting = true;
            } catch (e) {
                _showLoadError('Cesium initialization failed: ' + e.message);
                return;
            }

            document.getElementById('loadingStatus').textContent = 'Initializing sim engine...';

            LiveSimEngine.init(_selectedSimPath, _selectedPlayerId, _viewer)
                .then(function(info) {
                    var title = info.observerMode ? 'OBSERVER' : info.playerName;
                    document.title = title + ' - Live Sim';
                    document.getElementById('playerNameDisplay').textContent = title;
                    document.getElementById('loadingStatus').textContent =
                        'Ready: ' + title + ' (' + info.entityCount + ' entities)';

                    return new Promise(function(r) { setTimeout(r, 400); });
                })
                .then(function() {
                    // Hide loading, show cockpit UI via settings-aware method
                    document.getElementById('loadingOverlay').style.display = 'none';
                    LiveSimEngine.showUI();

                    // Wire up game loop
                    _viewer.clock.onTick.addEventListener(function() {
                        LiveSimEngine.tick();
                    });
                })
                .catch(function(e) {
                    _showLoadError(e.message);
                    console.error(e);
                });
        }

        function _showLoadError(msg) {
            var errEl = document.getElementById('loadingError');
            if (errEl) {
                errEl.textContent = msg;
                errEl.style.display = 'block';
            }
            document.getElementById('loadingStatus').textContent = 'Failed';
        }

        // =====================================================================
        // Event bindings
        // =====================================================================

        // Back button
        document.getElementById('btnBackToSims').addEventListener('click', function() {
            document.getElementById('splashStep2').style.display = 'none';
            document.getElementById('splashStep1').style.display = 'block';
            _selectedSimPath = null;
            _selectedPlayerId = null;
            _scenarioJson = null;
        });

        // Launch button
        document.getElementById('btnLaunchCockpit').addEventListener('click', function() {
            if (!_selectedSimPath || !_selectedPlayerId) return;
            launchSim();
        });

        // Observe button (no player)
        document.getElementById('btnObserve').addEventListener('click', function() {
            if (!_selectedSimPath) return;
            _selectedPlayerId = '__observer__';
            launchSim();
        });

        // =====================================================================
        // Helpers
        // =====================================================================
        function _escHtml(s) {
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // =====================================================================
        // HUD Brightness Slider
        // =====================================================================
        (function initHudBrightness() {
            var slider = document.getElementById('hudBrightness');
            var valDisplay = document.getElementById('hudBrightnessVal');
            var hudCanvas = document.getElementById('hudCanvas');
            if (!slider || !hudCanvas) return;

            // Restore from localStorage
            var savedBrightness = localStorage.getItem('liveSimHudBrightness');
            if (savedBrightness !== null) {
                var val = parseInt(savedBrightness, 10);
                if (val >= 30 && val <= 200) {
                    slider.value = val;
                    hudCanvas.style.opacity = val / 100;
                    if (valDisplay) valDisplay.textContent = val + '%';
                }
            }

            slider.addEventListener('input', function() {
                var val = parseInt(slider.value, 10);
                hudCanvas.style.opacity = val / 100;
                if (valDisplay) valDisplay.textContent = val + '%';
                localStorage.setItem('liveSimHudBrightness', String(val));
            });
        })();

        // =====================================================================
        // HUD All On / All Off Buttons
        // =====================================================================
        (function initHudToggleAll() {
            var btnOn = document.getElementById('hudAllOn');
            var btnOff = document.getElementById('hudAllOff');
            if (!btnOn || !btnOff) return;

            function setAllHud(state) {
                var dropdown = document.getElementById('settingsDropdown');
                if (!dropdown) return;
                var items = dropdown.querySelectorAll('.settings-item[data-hud]');
                for (var i = 0; i < items.length; i++) {
                    var key = items[i].getAttribute('data-hud');
                    if (!key) continue;
                    // Update FighterHUD toggles
                    if (typeof FighterHUD !== 'undefined' && FighterHUD.setToggle) {
                        FighterHUD.setToggle(key, state);
                    }
                    // Update visual checkbox state
                    if (state) {
                        items[i].classList.add('active');
                    } else {
                        items[i].classList.remove('active');
                    }
                    var check = items[i].querySelector('.settings-check');
                    if (check) check.innerHTML = state ? '&#10003;' : '';
                }
                // Save preferences via LiveSimEngine if available
                if (typeof LiveSimEngine !== 'undefined' && LiveSimEngine._savePanelPrefs) {
                    LiveSimEngine._savePanelPrefs();
                }
                // Fallback: save HUD toggles directly
                try {
                    var saved = localStorage.getItem('livesim_panels');
                    if (saved) {
                        var prefs = JSON.parse(saved);
                        if (typeof FighterHUD !== 'undefined' && FighterHUD.getToggles) {
                            prefs.hudToggles = FighterHUD.getToggles();
                        }
                        localStorage.setItem('livesim_panels', JSON.stringify(prefs));
                    }
                } catch (e) { /* ignore */ }
            }

            btnOn.addEventListener('click', function(e) {
                e.stopPropagation();
                setAllHud(true);
            });
            btnOff.addEventListener('click', function(e) {
                e.stopPropagation();
                setAllHud(false);
            });
        })();

        // =====================================================================
        // Start
        // =====================================================================
        initSplash();
    })();
    </script>
</body>
</html>
